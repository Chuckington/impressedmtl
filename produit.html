<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Personnalisations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Supabase JS UMD via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Lien vers la feuille de style principale -->
  <link rel="stylesheet" href="assets/css/main.css">
  <!-- === FAVICON === -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <!-- =============== -->
</head>
<body>
  <header>
    <button class="hamburger-btn" id="hamburger-btn">‚ò∞</button>
    <div class="header-left">
      <a href="index.html" class="header-logo">
        <img src="assets/logo2.png" alt="Logo Impressed MTL">
      </a>
    </div>
    <div class="header-title">
      <h1 id="page-title">Chargement...</h1>
      <p id="page-subtitle"></p>
    </div>
    <div class="header-actions">
      <a href="panier.html" class="btn">Panier</a>
      <button id="auth-button" class="btn">Se connecter</button>
      <span id="user-email" style="color:#333;"></span>
    </div>
  </header>
  <!-- NOUVEAU: Menu de navigation mobile -->
  <nav class="header-nav-mobile" id="mobile-nav">
    <a href="index.html">Accueil</a>
    <a href="inventaire.html">Inventaire</a>
    <a href="contact.html">Nous contacter</a>
    <a href="about.html">√Ä propos</a>
    <a href="panier.html">Panier</a>
  </nav>

  <div class="container">
    <div id="offer-info-box" style="display:none; margin-bottom: 30px;"></div>
    <div id="custom-list" class="grid"><p>Chargement...</p></div>
    <div id="order-summary">
      <div class="order-summary-top-row">
        <div class="option-group">
          <label for="quantity">Quantit√©:</label>
          <input type="number" id="quantity" value="1" min="1">
        </div>

        <div class="option-group" id="color-option-group">
          <label for="color-select">Couleur:</label>
          <div class="color-input-wrapper">
            <select id="color-select"><option value="">Choisir...</option></select>
            <span id="color-preview"></span>
          </div>
        </div>

        <div class="option-group" id="gender-option-group">
          <label for="gender-select">Sexe:</label>
          <select id="gender-select"><option value="">Choisir...</option></select>
        </div>
        <div class="summary-actions-container">
          <div class="total-price-display">Total: <span id="total-price">0.00</span> $</div>
          <button id="add-to-cart" class="btn">Ajouter au panier</button>
        </div>
      </div>
      <div class="order-summary-bottom-row">
        <div class="option-group" id="size-option-group">
          <label>Tailles :</label>
          <div class="size-inputs-column">
            <div id="size-inputs-container" class="size-inputs-wrapper"></div>
            <div id="size-validation-message"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pop-up pour l'offre sp√©ciale -->
  <div id="offer-popup-overlay" class="popup-overlay" style="display: none;">
    <div class="popup-content">
      <h2>üéâ Offre Sp√©ciale D√©bloqu√©e ! üéâ</h2>
      <p>Vous avez s√©lectionn√© <strong>20 unit√©s ou plus</strong> avec un "Gros design derri√®re" et un "Petit design poitrine".</p>
      <p>Le rabais sera appliqu√© automatiquement dans votre panier.</p>
      <button id="close-offer-popup-btn" class="btn">Super !</button>
    </div>
  </div>

  <script>
    // Initialise Supabase client une seule fois
    const supa = supabase.createClient(
      'https://vwvvbtcatamszncjuiso.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3dnZidGNhdGFtc3puY2p1aXNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NzM4ODksImV4cCI6MjA1ODI0OTg4OX0.Vnk3723jDNQdcl7HfVXZRtL6z0KxOLV4l872azuyEWA'
    );

    // Auth logic
    const authBtn = document.getElementById('auth-button');
    const userEmail = document.getElementById('user-email');
    async function updateAuthUI() {
      const { data: { user } } = await supa.auth.getUser();
      if (user) {
        userEmail.textContent = user.email;
        authBtn.textContent = 'Se d√©connecter';
      } else {
        userEmail.textContent = '';
        authBtn.textContent = 'Se connecter';
      }
    }
    authBtn.addEventListener('click', async () => {
      const { data: { user } } = await supa.auth.getUser();
      if (user) await supa.auth.signOut(); else window.location.href = 'login.html';
      updateAuthUI();
    });
    supa.auth.onAuthStateChange(updateAuthUI);
    updateAuthUI();

    // Lecture du param√®tre table
    const params = new URLSearchParams(window.location.search);
    const tableName = params.get('table')?.trim().toLowerCase();

    const nomsPropres = {
      inventairecrewneck: 'Crewneck',
      inventairehoodie: 'Hoodie',
      inventairepolosport: 'Polo Sport',
      inventairesousverrerond: 'Sous-verre sublim√© (4 pack) mod√®le rond',
      inventairesousverrecarre: 'Sous-verre sublim√© (4 pack) mod√®le carr√©',
      inventairetablier: 'Tablier',
      inventairetotebag: 'Tote Bag',
      inventairetshirtcroptop: 'T-Shirt Crop top',
      inventairetshirtdebase: 'T-Shirt de base',
      inventairetshirtlongsleeve: 'Long Sleeve',
      inventairetshirtpremium: 'T-Shirt Premium - Sport',
      inventairetuque: 'Tuque',
      inventaireveste: 'Veste',
      inventairetapisdesouris: 'Tapis de souris'
    };
    const noCheckbox = ['inventairesousverrecarre','inventairesousverrerond','inventairetapisdesouris'];

    async function loadData() {
      const titleEl = document.getElementById('page-title');
      const subtitleEl = document.getElementById('page-subtitle');
      const container = document.getElementById('custom-list');
      const qtyInput = document.getElementById('quantity');
      const totalEl = document.getElementById('total-price');
      const colorSelect = document.getElementById('color-select');
      const genderSelect = document.getElementById('gender-select');
      const colorPreview = document.getElementById('color-preview');
      const offerInfoBox = document.getElementById('offer-info-box');
      const offerPopupOverlay = document.getElementById('offer-popup-overlay');
      const closeOfferPopupBtn = document.getElementById('close-offer-popup-btn');
      let hasShownOfferPopup = false; // Pour ne montrer le popup qu'une fois par session
      
      // R√©cup√©rer les conteneurs des groupes d'options
      const colorOptionGroup = document.getElementById('color-option-group');
      const sizeOptionGroup = document.getElementById('size-option-group');
      const genderOptionGroup = document.getElementById('gender-option-group');

      // V√©rification table
      if (!tableName || !nomsPropres[tableName]) {
        titleEl.textContent = 'Erreur';
        container.innerHTML = '<p>Produit inconnu.</p>';
        return;
      }
      titleEl.textContent = `Personnalisations pour ${nomsPropres[tableName]}`;
      subtitleEl.textContent = 'Choisissez vos options';

      // Afficher l'encadr√© de l'offre sp√©ciale
      if (tableName === 'inventairetshirtdebase') {
        offerInfoBox.style.display = 'block';
        offerInfoBox.innerHTML = `
          <h3>‚ú® Offre Sp√©ciale ‚ú®</h3>
          <p>Commandez <strong>20 unit√©s</strong> avec un "Gros design derri√®re" ET un "Petit design poitrine" (gauche ou droite) pour un prix fixe de <strong>300$</strong> ! Le rabais sera appliqu√© automatiquement dans le panier.</p>
        `;
      } else if (tableName === 'inventairetshirtpremium') {
        offerInfoBox.style.display = 'block';
        offerInfoBox.innerHTML = `
          <h3>‚ú® Offre Sp√©ciale ‚ú®</h3>
          <p>Commandez <strong>20 unit√©s</strong> avec un "Gros design derri√®re" ET un "Petit design poitrine" (gauche ou droite) pour un prix fixe de <strong>420$</strong> ! Le rabais sera appliqu√© automatiquement dans le panier.</p>
        `;
      }

      // Construire la requ√™te pour le prix de base depuis la table 'inventaire'
      let basePriceQuery = supa.from('inventaire').select('prix');

      if (tableName === 'inventairesousverrerond') {
        basePriceQuery = basePriceQuery
          .eq('nom', 'Sous-verre sublim√© (4 pack)')
          .eq('mod√®le', 'Rond'); // Assurez-vous que 'Rond' correspond exactement √† la valeur dans votre DB
      } else if (tableName === 'inventairesousverrecarre') {
        basePriceQuery = basePriceQuery
          .eq('nom', 'Sous-verre sublim√© (4 pack)')
          .eq('mod√®le', 'Carr√©'); // Assurez-vous que 'Carr√©' correspond exactement √† la valeur dans votre DB
      } else {
        basePriceQuery = basePriceQuery.eq('nom', nomsPropres[tableName]);
      }
      const { data: baseDataInv, error: baseErrInv } = await basePriceQuery.single();

      // Ce prix sera utilis√© comme base, sauf s'il est surcharg√© (ex: pour noCheckbox items)
      let effectiveBasePrice = (!baseErrInv && baseDataInv) ? parseFloat(baseDataInv.prix) : 0;

      // Pour d√©bogage du point 3 (Polo Sport)
      if (tableName === 'inventairepolosport') {
        console.log(`Polo Sport: Prix initial r√©cup√©r√© de la table 'inventaire' (cl√©: '${nomsPropres[tableName]}'): ${effectiveBasePrice}`);
        if (effectiveBasePrice === 0) {
            console.warn("Polo Sport: Le prix de base est 0. V√©rifiez l'entr√©e correspondante dans la table 'inventaire'. Elle devrait avoir un prix (ex: 25$).");
        }
      }

      // R√©cup√©rer personnalisations
      const { data, error } = await supa
        .from(tableName)
        .select('*')
        .order('nom', { ascending: true });
      if (error) {
        console.error('Supabase error:', error);
        container.innerHTML = '<p>Erreur chargement.</p>';
        return;
      }
      container.innerHTML = '';

      // Pour les produits sans case √† cocher, le effectiveBasePrice (de la table 'inventaire') est d√©j√† correct.
      // Nous nous assurons simplement que leur prix de modification est 0.
      if (noCheckbox.includes(tableName) && data && data.length > 0) {
        // L'effectiveBasePrice est d√©j√† celui de la table 'inventaire'.
        // data[0].prix de la table sp√©cifique (ex: inventairesousverrerond.prix) n'est pas utilis√© pour le prix de base ici.
      }

      // Charger et peupler les options de couleur
      const { data: availableColorsData, error: colorsError } = await supa
        .from('product_available_colors')
        .select(`colors (id, name, hex_code)`) // Jointure pour obtenir les d√©tails de la couleur
        .eq('product_table_ref', tableName);

      if (!colorsError && availableColorsData && availableColorsData.length > 0) {
        // Le groupe est visible par d√©faut, on peuple juste
        availableColorsData.forEach(item => {
          const color = item.colors; // Acc√©der √† l'objet couleur joint
          if (color) {
            const option = document.createElement('option');
            option.value = color.id;
            option.textContent = color.name;
            option.dataset.hex = color.hex_code;
            colorSelect.appendChild(option);
          }
        });
        colorSelect.addEventListener('change', (event) => {
          const selectedOption = event.target.selectedOptions[0];
          colorPreview.style.backgroundColor = selectedOption.dataset.hex || 'transparent';
        });
      } else {
        colorOptionGroup.style.display = 'none'; // Cacher si pas d'options
      }

      // Charger et peupler les options de taille
      const sizeInputsContainer = document.getElementById('size-inputs-container');
      const sizeValidationMessage = document.getElementById('size-validation-message');

      const { data: availableSizesData, error: sizesError } = await supa
        .from('product_available_sizes')
        .select(`sizes (id, name)`)
        .eq('product_table_ref', tableName)
        .order('id', { referencedTable: 'sizes', ascending: true }); // Ordonner les tailles

      if (!sizesError && availableSizesData && availableSizesData.length > 0) {
        availableSizesData.forEach(item => {
          const size = item.sizes;
          if (size) {
            const sizeInputGroup = document.createElement('div');
            sizeInputGroup.className = 'size-input-group';
            
            const label = document.createElement('label');
            label.htmlFor = `size-qty-${size.id}`;
            label.textContent = size.name;
            
            const input = document.createElement('input');
            input.type = 'number';
            input.id = `size-qty-${size.id}`;
            input.className = 'size-quantity-input';
            input.min = 0;
            input.value = 0;
            input.dataset.sizeId = size.id;
            input.dataset.sizeName = size.name;

            sizeInputGroup.appendChild(label);
            sizeInputGroup.appendChild(input);
            sizeInputsContainer.appendChild(sizeInputGroup);
          }
        });

        // Ajouter les √©couteurs pour la validation
        qtyInput.addEventListener('input', validateSizeQuantities);
        sizeInputsContainer.addEventListener('input', validateSizeQuantities);
        validateSizeQuantities(); // V√©rification initiale
      } else {
        sizeOptionGroup.style.display = 'none'; // Cacher si pas d'options
      }

      // Charger et peupler les options de sexe
      const { data: availableGendersData, error: gendersError } = await supa
        .from('product_available_genders')
        .select(`genders (id, name)`)
        .eq('product_table_ref', tableName);

      // Debugging for gender options
      console.log('[DEBUG] Requ√™te pour les sexes (genders) pour tableName:', tableName);
      console.log('[DEBUG] Donn√©es des sexes (availableGendersData):', JSON.stringify(availableGendersData, null, 2));
      if (gendersError) {
        console.error('[DEBUG] Erreur lors de la r√©cup√©ration des sexes (gendersError):', JSON.stringify(gendersError, null, 2));
      }

      if (!gendersError && availableGendersData && availableGendersData.length > 0) {
        // Le groupe est visible par d√©faut
        availableGendersData.forEach(item => {
          const gender = item.genders;
          if (gender) {
            const option = document.createElement('option');
            option.value = gender.id;
            option.textContent = gender.name;
            genderSelect.appendChild(option);
          }
        });
      } else {
        genderOptionGroup.style.display = 'none'; // Cacher si pas d'options
      }


      data.forEach((item, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.style.animationDelay = `${idx * 0.05}s`;

        let cardHtml = `
          <div class="card-image">
            <img src="${item.image_url || 'placeholder.png'}" alt="${item.nom}">
          </div>
          <div class="card-content">
            <h3>${item.nom}</h3>
        `;

        const displayedItemBasePrice = effectiveBasePrice;
        // Le 'prix' de la table sp√©cifique (ex: inventairesousverrerond.prix) est le co√ªt de la modification.
        const modificationPriceForThisSpot = parseFloat(item.prix); 

        // Point 1: Ajustement pour les produits sans case √† cocher
        if (noCheckbox.includes(tableName)) {
          // Pour ces articles, le prix de base inclut d√©j√† la personnalisation.
          cardHtml += `
            <p><strong>Prix:</strong> ${displayedItemBasePrice.toFixed(2)}$ (Personnalisation incluse)</p>
            <div class="upload-section" id="upload-section-${item.id}" style="display:block; margin-left:0; margin-top:10px;">
              <label for="file-input-${item.id}" class="btn btn-small">Choisir fichier (${item.nom || 'Design'})</label>
              <input type="file" id="file-input-${item.id}" data-spot-label="${item.nom || 'Design personnalis√©'}" accept="image/*" style="display:none;">
              <div class="preview-wrapper">
                <img id="preview-${item.id}" src="#" alt="Aper√ßu" style="display:none;">
              </div>
            </div>
          `;
        } else {
          // Logique existante pour les articles avec case √† cocher
          cardHtml += `
            <p><strong>Prix de base:</strong> ${displayedItemBasePrice.toFixed(2)}$</p>
            <p><strong>Prix modification:</strong> ${modificationPriceForThisSpot.toFixed(2)}$</p>
          `;

          const desc = item.personnalisation?.toLowerCase() || '';
          if (desc.includes('gros design')) {
            if (tableName !== 'inventaireveste') { // Point 4: Veste - pas de "Gros design devant"
              cardHtml += `
                <div class="personalize-option-group">
                  <div class="personalize">
                    <input type="checkbox" class="personalization-checkbox" data-price="${modificationPriceForThisSpot}" id="opt-${item.id}-front">
                    <label for="opt-${item.id}-front">Gros design devant</label>
                  </div>
                  <div class="upload-section" id="upload-section-${item.id}-front" style="display:none;">
                    <label for="file-input-${item.id}-front" class="btn btn-small">Choisir fichier (devant)</label>
                    <input type="file" id="file-input-${item.id}-front" accept="image/*" style="display:none;">
                    <div class="preview-wrapper">
                      <img id="preview-${item.id}-front" src="#" alt="Aper√ßu" style="display:none;">
                    </div>
                  </div>
                </div>
              `;
            }
            if (tableName !== 'inventairetablier') { // Point 2: Tablier - pas de "Gros design derri√®re"
              cardHtml += `
                <div class="personalize-option-group">
                  <div class="personalize">
                    <input type="checkbox" class="personalization-checkbox" data-price="${modificationPriceForThisSpot}" id="opt-${item.id}-back">
                    <label for="opt-${item.id}-back">Gros design derri√®re</label>
                  </div>
                  <div class="upload-section" id="upload-section-${item.id}-back" style="display:none;">
                    <label for="file-input-${item.id}-back" class="btn btn-small">Choisir fichier (derri√®re)</label>
                    <input type="file" id="file-input-${item.id}-back" accept="image/*" style="display:none;">
                    <div class="preview-wrapper">
                      <img id="preview-${item.id}-back" src="#" alt="Aper√ßu" style="display:none;">
                    </div>
                  </div>
                </div>
              `;
            }
          } else if (desc.includes('petit design poitrine')) {
            cardHtml += `
              <div class="personalize-option-group">
                <div class="personalize">
                  <input type="checkbox" class="personalization-checkbox" data-price="${modificationPriceForThisSpot}" id="opt-${item.id}-left">
                  <label for="opt-${item.id}-left">Petit design poitrine gauche</label>
                </div>
                <div class="upload-section" id="upload-section-${item.id}-left" style="display:none;">
                  <label for="file-input-${item.id}-left" class="btn btn-small">Choisir fichier (gauche)</label>
                  <input type="file" id="file-input-${item.id}-left" accept="image/*" style="display:none;">
                  <div class="preview-wrapper">
                    <img id="preview-${item.id}-left" src="#" alt="Aper√ßu" style="display:none;">
                  </div>
                </div>
              </div>
              <div class="personalize-option-group">
                <div class="personalize">
                  <input type="checkbox" class="personalization-checkbox" data-price="${modificationPriceForThisSpot}" id="opt-${item.id}-right">
                  <label for="opt-${item.id}-right">Petit design poitrine droite</label>
                </div>
                <div class="upload-section" id="upload-section-${item.id}-right" style="display:none;">
                  <label for="file-input-${item.id}-right" class="btn btn-small">Choisir fichier (droite)</label>
                  <input type="file" id="file-input-${item.id}-right" accept="image/*" style="display:none;">
                  <div class="preview-wrapper">
                    <img id="preview-${item.id}-right" src="#" alt="Aper√ßu" style="display:none;">
                  </div>
                </div>
              </div>
            `;
          } else if (item.personnalisation) { // Cas g√©n√©ral pour les autres personnalisations avec checkbox
            cardHtml += `
              <div class="personalize-option-group">
                <div class="personalize">
                  <input type="checkbox" class="personalization-checkbox" data-price="${modificationPriceForThisSpot}" id="opt-${item.id}">
                  <label for="opt-${item.id}">${item.personnalisation}</label>
                </div>
                <div class="upload-section" id="upload-section-${item.id}" style="display:none;">
                  <label for="file-input-${item.id}" class="btn btn-small">Choisir fichier (${item.personnalisation})</label>
                  <input type="file" id="file-input-${item.id}" accept="image/*" style="display:none;">
                  <div class="preview-wrapper">
                    <img id="preview-${item.id}" src="#" alt="Aper√ßu" style="display:none;">
                  </div>
                </div>
              </div>
            `;
          }
        }
        cardHtml += '</div>'; // Fin de card-content
        card.innerHTML = cardHtml;
        container.appendChild(card);
      });

      // Calcul du total
      function updateTotal() {
        const qty = parseInt(qtyInput.value) || 1;
        const extraCost = Array.from(document.querySelectorAll('.personalization-checkbox:checked'))
          // On ne somme que les data-price des checkboxes, pas d'autres inputs qui pourraient avoir data-price
          .filter(cb => cb.type === 'checkbox') 
          .reduce((sum, cb) => sum + parseFloat(cb.dataset.price), 0);
        
        const newTotalValue = (effectiveBasePrice + extraCost) * qty;
        const newTotalString = newTotalValue.toFixed(2);

        // Log de d√©bogage pour v√©rifier les valeurs
        console.log('[DEBUG] Appel de updateTotal:');
        console.log('  - Prix de base effectif (effectiveBasePrice):', effectiveBasePrice);
        console.log('  - Co√ªt suppl√©mentaire (extraCost):', extraCost);
        console.log('  - Quantit√© (qty):', qty);
        console.log('  - Valeur totale calcul√©e (newTotalValue):', newTotalValue);
        console.log('  - Cha√Æne √† afficher (newTotalString):', newTotalString);

        // Reporter la mise √† jour du DOM au prochain "animation frame"
        // Cela peut aider √† r√©soudre les probl√®mes d'affichage initiaux
        requestAnimationFrame(() => {
          totalEl.textContent = newTotalString;
          console.log('[DEBUG] totalEl.textContent mis √† jour √†:', newTotalString);
        });
      }
      qtyInput.addEventListener('input', updateTotal);
      container.addEventListener('change', async e => { // Ajout de async ici
        if (e.target.classList.contains('personalization-checkbox')) {
          updateTotal();
          // Afficher/cacher la section d'upload correspondante
          const checkboxId = e.target.id; // ex: opt-ITEMID-front
          const baseId = checkboxId.replace('opt-', ''); // ex: ITEMID-front
          const uploadSection = document.getElementById(`upload-section-${baseId}`);
          if (uploadSection) {
            uploadSection.style.display = e.target.checked ? 'block' : 'none';
            if (!e.target.checked) {
              // Optionnel: R√©initialiser l'input fichier et la pr√©visualisation si d√©coch√©
              const fileInput = document.getElementById(`file-input-${baseId}`);
              const preview = document.getElementById(`preview-${baseId}`);
              if (fileInput) fileInput.value = ''; // R√©initialise le champ fichier
              if (preview) {
                preview.style.display = 'none';
                preview.src = '#';
                // Supprimer l'URL stock√©e si vous la stockez sur la checkbox
                delete e.target.dataset.imageUrl;
              }
            }
          }
        }
        // G√©rer la s√©lection de fichier pour l'upload
        if (e.target.type === 'file' && e.target.id.startsWith('file-input-')) {
          const file = e.target.files[0];
          const fileInput = e.target;
          const baseId = fileInput.id.replace('file-input-', ''); // ex: ITEMID-front
          const previewElement = document.getElementById(`preview-${baseId}`);
          const checkboxElement = document.getElementById(`opt-${baseId}`); // La checkbox associ√©e
          const uploadLabel = fileInput.previousElementSibling; // Le <label> qui sert de bouton

          if (file && previewElement && checkboxElement && uploadLabel) {
            // Pr√©visualisation
            const reader = new FileReader();
            reader.onload = function(event) {
              previewElement.src = event.target.result;
              previewElement.style.display = 'block';
            }
            reader.readAsDataURL(file);

            // Upload vers Supabase Storage
            uploadLabel.textContent = 'Chargement...'; // Indiquer l'upload en cours
            fileInput.disabled = true;

            // Sanitize the file name to remove/replace problematic characters
            const sanitizedBaseName = file.name
              .normalize('NFD') // Decompose accented characters (e.g., √© -> e + ¬¥)
              .replace(/[\u0300-\u036f]/g, '') // Remove diacritical marks (the accents)
              .replace(/[^\w.-]/g, '_') // Replace non-alphanumeric (excluding . -) and other special chars with _
              .replace(/_{2,}/g, '_'); // Replace multiple consecutive underscores with a single one
            const uniqueFileName = `${Date.now()}-${sanitizedBaseName}`;
            // Optionnel: Organiser par utilisateur si connect√©
            const { data: { user } } = await supa.auth.getUser();
            const filePath = user ? `${user.id}/${uniqueFileName}` : `public/${uniqueFileName}`;

            const { data: uploadData, error: uploadError } = await supa.storage
              .from('designs-clients') // Nom de votre bucket
              .upload(filePath, file);

            if (uploadError) {
              console.error("Erreur d'upload Supabase:", uploadError);
              alert("Erreur lors de l'upload de l'image.");
              uploadLabel.textContent = 'Choisir fichier';
              fileInput.disabled = false;
            } else {
              console.log('Upload Supabase r√©ussi:', uploadData);
              const { data: publicURLData } = supa.storage
                .from('designs-clients')
                .getPublicUrl(uploadData.path);
              
              if (noCheckbox.includes(tableName)) {
                fileInput.dataset.imageUrl = publicURLData.publicUrl; // Stocker l'URL sur l'input file lui-m√™me
              } else if (checkboxElement) {
                checkboxElement.dataset.imageUrl = publicURLData.publicUrl; // Stocker l'URL sur la checkbox
              }
              uploadLabel.textContent = 'Fichier charg√© ‚úì';
              fileInput.disabled = false;
            }
          }
        }
      });
      updateTotal();

      // Fonction pour v√©rifier si la somme des tailles correspond √† la quantit√© totale
      function validateSizeQuantities() {
        const masterQty = parseInt(qtyInput.value) || 0;
        const sizeInputs = document.querySelectorAll('.size-quantity-input');
        let totalSizeQty = 0;
        sizeInputs.forEach(input => {
          totalSizeQty += parseInt(input.value) || 0;
        });

        if (totalSizeQty < masterQty) {
          sizeValidationMessage.textContent = `Il manque ${masterQty - totalSizeQty} article(s) √† r√©partir.`;
          sizeValidationMessage.style.color = 'orange';
        } else if (totalSizeQty > masterQty) {
          sizeValidationMessage.textContent = `Vous avez r√©parti ${totalSizeQty - masterQty} article(s) en trop.`;
          sizeValidationMessage.style.color = 'red';
        } else { // totalSizeQty === masterQty
          sizeValidationMessage.textContent = 'Nombre de morceaux de la quantit√© demand√©e est atteint.';
          sizeValidationMessage.style.color = 'green';
        }
      }

      // Fonction pour v√©rifier les conditions de l'offre et afficher le pop-up
      function checkOfferConditionsAndShowPopup() {
        if (hasShownOfferPopup) return;

        const qty = parseInt(qtyInput.value) || 1;
        const isEligibleProduct = tableName === 'inventairetshirtdebase' || tableName === 'inventairetshirtpremium';
        
        if (!isEligibleProduct) {
          return;
        }

        // Safely find the personalization items
        const grosDesignItem = data.find(item => item.personnalisation?.toLowerCase().includes('gros design'));
        const petitDesignItem = data.find(item => item.personnalisation?.toLowerCase().includes('petit design poitrine'));

        // If the required personalization options don't exist for this product, exit.
        if (!grosDesignItem || !petitDesignItem) {
            return;
        }

        const hasGrosDerriere = document.getElementById(`opt-${grosDesignItem.id}-back`)?.checked;
        const hasPetitPoitrineGauche = document.getElementById(`opt-${petitDesignItem.id}-left`)?.checked;
        const hasPetitPoitrineDroite = document.getElementById(`opt-${petitDesignItem.id}-right`)?.checked;
        
        const hasPetitPoitrine = hasPetitPoitrineGauche || hasPetitPoitrineDroite;

        if (qty >= 20 && hasGrosDerriere && hasPetitPoitrine) {
          offerPopupOverlay.style.display = 'flex';
          hasShownOfferPopup = true;
        }
      }

      // √âcouteurs pour le pop-up
      closeOfferPopupBtn.addEventListener('click', () => {
        offerPopupOverlay.style.display = 'none';
      });

      // Appeler la v√©rification des conditions apr√®s chaque changement pertinent
      qtyInput.addEventListener('input', checkOfferConditionsAndShowPopup);
      container.addEventListener('change', checkOfferConditionsAndShowPopup); // Pour les checkboxes

      // Ajouter au panier
      document.getElementById('add-to-cart').addEventListener('click', async () => {
        try {
            const qty = parseInt(qtyInput.value) || 1;
            
            let personalizationsData = [];

            if (noCheckbox.includes(tableName)) {
              // Pour les articles sans case √† cocher, r√©cup√©rer l'image depuis l'input file
              const fileInputs = document.querySelectorAll(`#custom-list input[type="file"][id^="file-input-"]`);
              fileInputs.forEach(fileInput => {
                if (fileInput.dataset.imageUrl) {
                  personalizationsData.push({
                    spot_label: fileInput.dataset.spotLabel || "Design personnalis√©",
                    spot_price: 0, // Le prix de la personnalisation est inclus
                    image_url: fileInput.dataset.imageUrl
                  });
                }
              });
            } else {
              // Logique existante pour les articles avec cases √† cocher
              const checkedPersonalizations = document.querySelectorAll('.personalization-checkbox:checked');
              for (const cbCheckbox of checkedPersonalizations) {
                const labelElement = cbCheckbox.labels[0];
                const label = labelElement ? labelElement.textContent.trim() : `Option ${cbCheckbox.id}`; 
                const price = parseFloat(cbCheckbox.dataset.price) || 0;
                personalizationsData.push({
                  spot_label: label,
                  spot_price: price,
                  image_url: cbCheckbox.dataset.imageUrl || null
                });
              }
            }

            const displayName = nomsPropres[tableName];

            const selectedColorOption = colorSelect.selectedOptions[0];
            const selectedColor = selectedColorOption && selectedColorOption.value ? 
                                  { id: selectedColorOption.value, name: selectedColorOption.textContent, hex: selectedColorOption.dataset.hex } : null;

            const selectedGenderOption = genderSelect.selectedOptions[0];
            const selectedGender = selectedGenderOption && selectedGenderOption.value ?
                                   { id: selectedGenderOption.value, name: selectedGenderOption.textContent } : null;

            const { data: { user } } = await supa.auth.getUser();
            
            // Logs pour d√©bogage
            console.log('Tentative d\'ajout au panier. Utilisateur:', user ? user.id : 'Invit√©');
            console.log('Produit:', displayName, `(ID: ${tableName})`);
            console.log('Quantit√©:', qty);
            console.log('Prix de base effectif:', effectiveBasePrice);
            console.log('S√©lections (personnalisations):', JSON.stringify(personalizationsData, null, 2));
            console.log('Couleur:', selectedColor, 'Sexe:', selectedGender);

            // Nouvelle logique pour les tailles multiples
            const sizeInputs = document.querySelectorAll('.size-quantity-input');
            const cartItemsToAdd = [];
            let totalSizeQty = 0;

            sizeInputs.forEach(input => {
                const sizeQty = parseInt(input.value) || 0;
                totalSizeQty += sizeQty;
                if (sizeQty > 0) {
                    cartItemsToAdd.push({
                        product_id: tableName, 
                        product_name: displayName, 
                        quantity: sizeQty, // Quantit√© pour cette taille sp√©cifique
                        personalizations: personalizationsData, 
                        base_price: effectiveBasePrice, 
                        selected_color_name: selectedColor ? selectedColor.name : null,
                        selected_size_name: input.dataset.sizeName, // Taille pour cet article
                        selected_gender_name: selectedGender ? selectedGender.name : null
                    });
                }
            });

            // Validation avant l'ajout
            if (qty > 0 && totalSizeQty !== qty) {
                alert('La somme des quantit√©s par taille ne correspond pas √† la quantit√© totale demand√©e.');
                return;
            }
            if (qty > 0 && cartItemsToAdd.length === 0) {
                alert('Veuillez sp√©cifier les quantit√©s pour au moins une taille.');
                return;
            }
            if (qty === 0) {
                alert('Veuillez choisir une quantit√© sup√©rieure √† 0.');
                return;
            }

            if (user) {
              // Ins√©rer plusieurs articles si n√©cessaire
              const { data: insertData, error: insertError } = await supa.from('cart_items').insert(cartItemsToAdd);

              if (insertError) {
                console.error("Erreur lors de l'ajout au panier (Supabase):", insertError);
                alert(`Erreur lors de l'ajout au panier: ${insertError.message}. D√©tails en console.`);
                return; 
              }
              alert('Article(s) ajout√©(s) au panier !');
              window.location.href = 'panier.html';
            } else {
              // Pour les utilisateurs non connect√©s, ajouter les articles au localStorage
              const cart = JSON.parse(localStorage.getItem('cart')) || [];
              cart.push(...cartItemsToAdd); // L'op√©rateur "spread" ajoute tous les √©l√©ments de cartItemsToAdd
              localStorage.setItem('cart', JSON.stringify(cart));
              alert('Article(s) ajout√©(s) au panier (non connect√©) !');
              window.location.href = 'panier.html';
            }
        } catch (error) {
            console.error("Erreur inattendue dans la fonction d'ajout au panier:", error);
            alert("Une erreur inattendue est survenue lors de l'ajout au panier. Veuillez v√©rifier la console pour plus de d√©tails.");
        }
      });
    }
    loadData();

    // --- Logique du menu Hamburger ---
    document.addEventListener('DOMContentLoaded', () => {
      const hamburgerBtn = document.getElementById('hamburger-btn');
      const mobileNav = document.getElementById('mobile-nav');

      hamburgerBtn.addEventListener('click', () => {
        mobileNav.classList.toggle('is-active');
        hamburgerBtn.textContent = mobileNav.classList.contains('is-active') ? '‚úï' : '‚ò∞';
      });
    });
  </script>
</body>
</html>
