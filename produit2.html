<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Configurateur de Produit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Supabase JS UMD via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Lien vers la feuille de style principale -->
  <link rel="stylesheet" href="assets/css/main.css">
  <!-- === FAVICON === -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <!-- =============== -->
</head>
<body>
  <header>
    <a href="inventaire.html" class="btn">← Retour à l’inventaire</a>
    <div class="header-title">
      <h1 id="page-title">Chargement...</h1>
    </div>
    <div style="display:flex; align-items:center; gap:8px;">
      <a href="panier.html" class="btn">Panier</a>
      <span id="user-email" style="color:#333;"></span>
      <button id="auth-button" class="btn">Se connecter</button>
    </div>
  </header>

  <div class="container configurator-container">
    <div class="configurator-options">
      <!-- Les cartes de personnalisation seront générées ici -->
      <div id="custom-list-v2" class="grid-v2"></div>
    </div>

    <div class="configurator-preview">
      <!-- Colonne de droite pour l'aperçu canvas -->
      <canvas id="product-canvas"></canvas>
      <div class="view-selector">
        <button class="btn view-btn active" data-view="front">Devant</button>
        <button class="btn view-btn" data-view="back">Dos</button>
        <button class="btn view-btn" data-view="sleeve_left">Manche Gauche</button>
        <button class="btn view-btn" data-view="sleeve_right">Manche Droite</button>
      </div>
    </div>
  </div>

  <!-- Barre de commande identique à produit.html -->
  <div id="order-summary">
    <div class="order-summary-top-row">
      <div class="option-group">
        <label for="quantity">Quantité:</label>
        <input type="number" id="quantity" value="1" min="1">
      </div>
      <div class="option-group" id="color-option-group">
        <label for="color-select">Couleur:</label>
        <div class="color-input-wrapper">
          <select id="color-select"><option value="">Choisir...</option></select>
          <span id="color-preview"></span>
        </div>
      </div>
      <div class="option-group" id="gender-option-group">
        <label for="gender-select">Sexe:</label>
        <select id="gender-select"><option value="">Choisir...</option></select>
      </div>
      <div class="summary-actions-container">
        <div class="total-price-display">Total: <span id="total-price">0.00</span> $</div>
        <button id="add-to-cart" class="btn">Ajouter au panier</button>
      </div>
    </div>
    <div class="order-summary-bottom-row">
      <div class="option-group" id="size-option-group">
        <label>Tailles :</label>
        <div class="size-inputs-column">
          <div id="size-inputs-container" class="size-inputs-wrapper"></div>
          <div id="size-validation-message"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const supa = supabase.createClient(
      'https://vwvvbtcatamszncjuiso.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3dnZidGNhdGFtc3puY2p1aXNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NzM4ODksImV4cCI6MjA1ODI0OTg4OX0.Vnk3723jDNQdcl7HfVXZRtL6z0KxOLV4l872azuyEWA'
    );

    // --- Auth Logic (identique à V1) ---
    // ... (le code d'authentification peut être copié/collé ici si nécessaire)

    // --- DOM Elements ---
    const canvas = document.getElementById('product-canvas');
    const ctx = canvas.getContext('2d');
    const pageTitleEl = document.getElementById('page-title');
    const customListEl = document.getElementById('custom-list-v2');
    const viewSelectorEl = document.querySelector('.view-selector');
    const colorSelectEl = document.getElementById('color-select');
    const qtyInput = document.getElementById('quantity');
    const genderSelectEl = document.getElementById('gender-select');
    const sizeInputsContainerEl = document.getElementById('size-inputs-container');
    const totalEl = document.getElementById('total-price');

    // --- App State ---
    const state = {
        product: null,
        currentColor: '#FFFFFF', // Couleur par défaut (blanc)
        currentView: 'front',    // Vue par défaut ('front', 'back', etc.)
        loadedImages: {},        // Cache pour les images déjà chargées
        personalizations: []     // Pour stocker les logos/designs uploadés
    };

    // --- Utilitaire de chargement d'image ---
    async function loadImage(url) {
        if (!url) return null;
        if (state.loadedImages[url]) return state.loadedImages[url];
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "Anonymous"; // Crucial pour le canvas
            img.onload = () => {
                state.loadedImages[url] = img;
                resolve(img);
            };
            img.onerror = () => reject(new Error(`Impossible de charger l'image: ${url}`));
            img.src = url;
        });
    }

    // --- Logique de rendu du Canvas ---
    async function renderProduct() {
        if (!state.product) return;

        // Sélectionne les URLs des images en fonction de la vue actuelle
        const baseImageUrl = state.product[`asset_base_${state.currentView}`];
        const maskImageUrl = state.product[`asset_mask_${state.currentView}`];

        if (!baseImageUrl || !maskImageUrl) {
            console.error(`Assets pour la vue '${state.currentView}' non trouvés.`);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ... (code pour afficher "Aperçu non disponible")
            return;
        }

        try {
            const [baseImg, maskImg] = await Promise.all([loadImage(baseImageUrl), loadImage(maskImageUrl)]);

            // Ajuster la taille du canvas à la première image chargée
            canvas.width = baseImg.width;
            canvas.height = baseImg.height;

            // Étape 1: Dessiner le masque (la forme noire)
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(maskImg, 0, 0);

            // Étape 2: Remplir la forme avec la couleur choisie
            ctx.globalCompositeOperation = 'source-in';
            ctx.fillStyle = state.currentColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Étape 3: Appliquer les ombres et la texture par-dessus
            ctx.globalCompositeOperation = 'multiply';
            ctx.drawImage(baseImg, 0, 0);

            // Étape 4: Réinitialiser pour les futurs dessins (logos, etc.)
            ctx.globalCompositeOperation = 'source-over';

            // TODO: Étape 5 - Dessiner les logos/designs de state.personalizations qui correspondent à la vue actuelle

        } catch (error) {
            console.error("Erreur lors du rendu du canvas:", error);
        }
    }

    // --- Génération des cartes de personnalisation (similaire à V1) ---
    function generatePersonalizationCards() {
        // Pour l'instant, les options sont codées en dur.
        // Idéalement, elles viendraient d'une table "personalization_options" liée au produit.
        const options = [
            { id: 1, nom: 'Gros Design', prix: 15.00, image_url: 'https://placehold.co/400x300/E7E7E7/A9A9A9?text=Gros+Design', options: ['front', 'back'] },
            { id: 2, nom: 'Petit Design Poitrine', prix: 8.00, image_url: 'https://placehold.co/400x300/E7E7E7/A9A9A9?text=Petit+Design', options: ['left', 'right'] }
        ];

        customListEl.innerHTML = '';
        options.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            let optionsHtml = '';
            if (item.nom.includes('Gros Design')) {
                optionsHtml = `
                    <div class="personalize"><input type="checkbox" class="personalization-checkbox" data-price="${item.prix}" id="opt-${item.id}-front"><label for="opt-${item.id}-front">Devant</label></div>
                    <div class="personalize"><input type="checkbox" class="personalization-checkbox" data-price="${item.prix}" id="opt-${item.id}-back"><label for="opt-${item.id}-back">Derrière</label></div>
                `;
            } else if (item.nom.includes('Petit Design')) {
                 optionsHtml = `
                    <div class="personalize"><input type="checkbox" class="personalization-checkbox" data-price="${item.prix}" id="opt-${item.id}-left"><label for="opt-${item.id}-left">Poitrine Gauche</label></div>
                    <div class="personalize"><input type="checkbox" class="personalization-checkbox" data-price="${item.prix}" id="opt-${item.id}-right"><label for="opt-${item.id}-right">Poitrine Droite</label></div>
                `;
            }

            card.innerHTML = `
              <div class="card-image"><img src="${item.image_url}" alt="${item.nom}"></div>
              <div class="card-content">
                <h3>${item.nom}</h3>
                <p><strong>Prix modification:</strong> ${item.prix.toFixed(2)}$</p>
                ${optionsHtml}
                <!-- Section d'upload à ajouter plus tard -->
              </div>`;
            customListEl.appendChild(card);
        });
    }

    // --- Logique de la barre de commande (inspirée de V1) ---
    async function initializeOrderBar() {
        // IMPORTANT: Assurez-vous d'avoir une colonne 'table_name_ref' dans votre table 'products'
        // Pour le T-Shirt de base, la valeur doit être 'inventairetshirtdebase'
        const tableNameRef = state.product.table_name_ref;
        if (!tableNameRef) {
            console.error("La référence 'table_name_ref' est manquante pour ce produit dans la base de données.");
            return;
        }

        // Charger les couleurs
        const { data: colorsData } = await supa.from('product_available_colors').select('colors(id, name, hex_code)').eq('product_table_ref', tableNameRef);
        if (colorsData) {
            colorsData.forEach(item => {
                const color = item.colors;
                const option = document.createElement('option');
                option.value = color.hex_code;
                option.textContent = color.name;
                colorSelectEl.appendChild(option);
            });
        }

        // Initialiser la couleur par défaut
        state.currentColor = colorSelectEl.value;
        document.getElementById('color-preview').style.backgroundColor = state.currentColor;

        // Charger les tailles
        const { data: sizesData } = await supa.from('product_available_sizes').select('sizes(id, name)').eq('product_table_ref', tableNameRef).order('id', { referencedTable: 'sizes', ascending: true });
        if (sizesData) {
            sizesData.forEach(item => {
                const size = item.sizes;
                const sizeInputGroup = document.createElement('div');
                sizeInputGroup.className = 'size-input-group';
                sizeInputGroup.innerHTML = `
                    <label for="size-qty-${size.id}">${size.name}</label>
                    <input type="number" id="size-qty-${size.id}" class="size-quantity-input" min="0" value="0" data-size-id="${size.id}" data-size-name="${size.name}">
                `;
                sizeInputsContainerEl.appendChild(sizeInputGroup);
            });
            qtyInput.addEventListener('input', validateSizeQuantities);
            sizeInputsContainerEl.addEventListener('input', validateSizeQuantities);
        }

        // Charger les sexes
        const { data: gendersData } = await supa.from('product_available_genders').select('genders(id, name)').eq('product_table_ref', tableNameRef);
        if (gendersData) {
            gendersData.forEach(item => {
                const gender = item.genders;
                const option = document.createElement('option');
                option.value = gender.id;
                option.textContent = gender.name;
                genderSelectEl.appendChild(option);
            });
        }

        // Mettre à jour le total
        updateTotal();
    }

    function updateTotal() {
        if (!state.product) return;
        const qty = parseInt(qtyInput.value) || 1;
        const extraCost = Array.from(document.querySelectorAll('.personalization-checkbox:checked'))
          .reduce((sum, cb) => sum + parseFloat(cb.dataset.price), 0);
        
        const newTotalValue = (state.product.base_price + extraCost) * qty;
        totalEl.textContent = newTotalValue.toFixed(2);
    }

    // Fonction pour valider les quantités de tailles (copiée de V1)
    function validateSizeQuantities() {
        const masterQty = parseInt(qtyInput.value) || 0;
        const sizeInputs = document.querySelectorAll('.size-quantity-input');
        let totalSizeQty = 0;
        sizeInputs.forEach(input => { totalSizeQty += parseInt(input.value) || 0; });

        const sizeValidationMessage = document.getElementById('size-validation-message');
        if (totalSizeQty < masterQty) {
            sizeValidationMessage.textContent = `Il manque ${masterQty - totalSizeQty} article(s) à répartir.`;
            sizeValidationMessage.style.color = 'orange';
        } else if (totalSizeQty > masterQty) {
            sizeValidationMessage.textContent = `Vous avez réparti ${totalSizeQty - masterQty} article(s) en trop.`;
            sizeValidationMessage.style.color = 'red';
        } else {
            sizeValidationMessage.textContent = 'Le compte est bon !';
            sizeValidationMessage.style.color = 'green';
        }
    }

    // --- Chargement des données et initialisation ---
    async function initializePage() {
        const params = new URLSearchParams(window.location.search);
        const productId = params.get('id');

        if (!productId) {
            pageTitleEl.textContent = "Produit non trouvé";
            return;
        }

        const { data, error } = await supa.from('products').select('*').eq('id', productId).single();

        if (error || !data) {
            console.error("Erreur de chargement du produit:", error);
            pageTitleEl.textContent = "Erreur de chargement";
            return;
        }

        state.product = data;
        pageTitleEl.textContent = state.product.name;

        generatePersonalizationCards();
        await initializeOrderBar();
        await renderProduct();
    }

    // --- Écouteurs d'événements ---
    colorSelectEl.addEventListener('change', (e) => {
        state.currentColor = e.target.value;
        document.getElementById('color-preview').style.backgroundColor = e.target.value;
        renderProduct();
    });

    viewSelectorEl.addEventListener('click', (e) => {
        if (e.target.classList.contains('view-btn')) {
            state.currentView = e.target.dataset.view;
            // Mettre à jour le bouton actif
            document.querySelector('.view-btn.active')?.classList.remove('active');
            e.target.classList.add('active');
            renderProduct();
        }
    });

    // Écouteurs pour la mise à jour du total
    qtyInput.addEventListener('input', updateTotal);
    customListEl.addEventListener('change', (e) => {
        if (e.target.classList.contains('personalization-checkbox')) {
            updateTotal();
        }
    });

    initializePage();
  </script>
</body>
</html>