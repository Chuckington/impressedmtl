<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Configurateur de Produit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Supabase JS UMD via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Lien vers la feuille de style principale -->
  <link rel="stylesheet" href="assets/css/main.css">
  <!-- === FAVICON === -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <!-- =============== -->
</head>
<body>
  <header>
    <a href="inventaire.html" class="btn">← Retour à l’inventaire</a>
    <div class="header-title">
      <h1 id="page-title">Chargement...</h1>
    </div>
    <div style="display:flex; align-items:center; gap:8px;">
      <a href="panier.html" class="btn">Panier</a>
      <span id="user-email" style="color:#333;"></span>
      <button id="auth-button" class="btn">Se connecter</button>
    </div>
  </header>

  <div class="container configurator-container">
    <div class="configurator-options">
      <!-- Les cartes de personnalisation seront générées ici -->
      <div id="custom-list-v2" class="grid-v2"></div>
    </div>

    <div class="configurator-preview">
      <!-- Colonne de droite pour l'aperçu canvas -->
      <canvas id="product-canvas"></canvas>
      <div class="view-selector">
        <button class="btn view-btn active" data-view="front">Devant</button>
        <button class="btn view-btn" data-view="back">Dos</button>
        <button class="btn view-btn" data-view="sleeve_left">Manche Gauche</button>
        <button class="btn view-btn" data-view="sleeve_right">Manche Droite</button>
      </div>
    </div>
  </div>

  <!-- Barre de commande identique à produit.html -->
  <div id="order-summary">
    <div class="order-summary-top-row">
      <div class="option-group">
        <label for="quantity">Quantité:</label>
        <input type="number" id="quantity" value="1" min="1">
      </div>
      <div class="option-group" id="color-option-group">
        <label for="color-select">Couleur:</label>
        <div class="color-input-wrapper">
          <select id="color-select"><option value="">Choisir...</option></select>
          <span id="color-preview"></span>
        </div>
      </div>
      <div class="option-group" id="gender-option-group">
        <label for="gender-select">Sexe:</label>
        <select id="gender-select"><option value="">Choisir...</option></select>
      </div>
      <div class="summary-actions-container">
        <div class="total-price-display">Total: <span id="total-price">0.00</span> $</div>
        <button id="add-to-cart" class="btn">Ajouter au panier</button>
      </div>
    </div>
    <div class="order-summary-bottom-row">
      <div class="option-group" id="size-option-group">
        <label>Tailles :</label>
        <div class="size-inputs-column">
          <div id="size-inputs-container" class="size-inputs-wrapper"></div>
          <div id="size-validation-message"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const supa = supabase.createClient(
      'https://vwvvbtcatamszncjuiso.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3dnZidGNhdGFtc3puY2p1aXNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NzM4ODksImV4cCI6MjA1ODI0OTg4OX0.Vnk3723jDNQdcl7HfVXZRtL6z0KxOLV4l872azuyEWA'
    );

    // --- Auth Logic (identique à V1) ---
    // ... (le code d'authentification peut être copié/collé ici si nécessaire)

    // --- DOM Elements ---
    const canvas = document.getElementById('product-canvas');
    const ctx = canvas.getContext('2d');
    const pageTitleEl = document.getElementById('page-title');
    const customListEl = document.getElementById('custom-list-v2');
    const viewSelectorEl = document.querySelector('.view-selector');
    const colorSelectEl = document.getElementById('color-select');
    const qtyInput = document.getElementById('quantity');
    const genderSelectEl = document.getElementById('gender-select');
    const sizeInputsContainerEl = document.getElementById('size-inputs-container');
    const totalEl = document.getElementById('total-price');

    // --- App State ---
    const state = {
        product: null,
        currentColor: '#FFFFFF', // Couleur par défaut (blanc)
        currentView: 'front',    // Vue par défaut ('front', 'back', etc.)
        loadedImages: {},        // Cache pour les images déjà chargées
        personalizations: []     // Pour stocker les logos/designs uploadés
    };

    // --- Utilitaire de chargement d'image ---
    async function loadImage(url) {
        if (!url) return null;
        if (state.loadedImages[url]) return state.loadedImages[url];
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "Anonymous"; // Crucial pour le canvas
            img.onload = () => {
                state.loadedImages[url] = img;
                resolve(img);
            };
            img.onerror = () => reject(new Error(`Impossible de charger l'image: ${url}`));
            img.src = url;
        });
    }

    // --- Logique de rendu du Canvas ---
    async function renderProduct() {
        if (!state.product) return;

        // Sélectionne les URLs des images en fonction de la vue actuelle
        const baseImageUrl = state.product[`asset_base_${state.currentView}`];
        const maskImageUrl = state.product[`asset_mask_${state.currentView}`];

        if (!baseImageUrl || !maskImageUrl) {
            console.error(`Assets pour la vue '${state.currentView}' non trouvés.`);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ... (code pour afficher "Aperçu non disponible")
            return;
        }

        try {
            const [baseImg, maskImg] = await Promise.all([loadImage(baseImageUrl), loadImage(maskImageUrl)]);

            // Ajuster la taille du canvas à la première image chargée
            canvas.width = baseImg.width;
            canvas.height = baseImg.height;

            // Étape 1: Dessiner le masque (la forme noire)
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(maskImg, 0, 0);

            // Étape 2: Remplir la forme avec la couleur choisie
            ctx.globalCompositeOperation = 'source-in';
            ctx.fillStyle = state.currentColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Étape 3: Appliquer les ombres et la texture par-dessus
            ctx.globalCompositeOperation = 'multiply';
            ctx.drawImage(baseImg, 0, 0);

            // Étape 4: Réinitialiser pour les futurs dessins (logos, etc.)
            ctx.globalCompositeOperation = 'source-over';

            // --- NOUVELLE LOGIQUE ---
            // Étape 5: Dessiner les logos/designs uploadés
            const checkedPersonalizations = document.querySelectorAll('.personalization-checkbox:checked');

            for (const checkbox of checkedPersonalizations) {
                const idParts = checkbox.id.split('-'); // e.g., ['opt', '1', 'front']
                const view = idParts.slice(2).join('_').replace('sleeve_', ''); // e.g., 'front', 'left', 'right'
                
                // Si la personnalisation cochée correspond à la vue actuelle et a une image
                if ((state.currentView === 'front' && (view === 'front' || view === 'left' || view === 'right')) || state.currentView === view) {
                    if (checkbox.dataset.imageUrl) {
                        try {
                            const logoImg = await loadImage(checkbox.dataset.imageUrl);
                            
                            // --- Logique de positionnement dans des boîtes prédéfinies ---
                            const placement = getPlacementBox(view, canvas.width, canvas.height);
                            
                            // Calculer les dimensions du logo pour qu'il rentre dans la boîte
                            const ratio = Math.min(placement.width / logoImg.width, placement.height / logoImg.height);
                            const logoWidth = logoImg.width * ratio;
                            const logoHeight = logoImg.height * ratio;
                            const logoX = placement.x + (placement.width - logoWidth) / 2; // Centrer horizontalement
                            const logoY = placement.y + (placement.height - logoHeight) / 2; // Centrer verticalement
                            
                            ctx.drawImage(logoImg, logoX, logoY, logoWidth, logoHeight);
                        } catch (error) {
                            console.error(`Impossible de dessiner le logo pour la vue ${view}:`, error);
                        }
                    }
                }
            }
        } catch (error) {
            console.error("Erreur lors du rendu du canvas:", error);
        }
    }

    // --- Génération des cartes de personnalisation (similaire à V1) ---
    async function generatePersonalizationCards() {
        // Récupérer les options de personnalisation depuis la table spécifique (ex: inventairetshirtdebase)
        const tableNameRef = state.product.table_name_ref;
        if (!tableNameRef) {
            console.error("La référence 'table_name_ref' est manquante pour ce produit.");
            customListEl.innerHTML = '<p>Options de personnalisation non disponibles.</p>';
            return;
        }

        const { data: options, error } = await supa
            .from(tableNameRef)
            .select('*')
            .order('nom', { ascending: true });

        if (error) {
            console.error("Erreur lors du chargement des options de personnalisation:", error);
            customListEl.innerHTML = '<p>Erreur de chargement des options.</p>';
            return;
        }

        customListEl.innerHTML = '';
        options.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            let optionsHtml = '';
            const modificationPrice = parseFloat(item.prix) || 0;

            const desc = item.personnalisation?.toLowerCase() || '';
            if (desc.includes('gros design')) {
                optionsHtml = `
                    <div class="personalize-option-group">
                      <div class="personalize">
                        <input type="checkbox" class="personalization-checkbox" data-price="${modificationPrice}" id="opt-${item.id}-front"><label for="opt-${item.id}-front">Devant</label>
                      </div>
                      <div class="upload-section" id="upload-section-${item.id}-front" style="display:none;">
                        <label for="file-input-${item.id}-front" class="btn btn-small">Choisir fichier (devant)</label>
                        <input type="file" id="file-input-${item.id}-front" accept="image/*" style="display:none;">
                        <div class="remove-bg-option">
                          <input type="checkbox" id="remove-bg-${item.id}-front" class="remove-bg-checkbox">
                          <label for="remove-bg-${item.id}-front">Enlever l'arrière-plan</label>
                        </div>
                        <div class="preview-wrapper"><img id="preview-${item.id}-front" src="#" alt="Aperçu" style="display:none;"></div>
                      </div>
                    </div>
                    <div class="personalize-option-group">
                      <div class="personalize">
                        <input type="checkbox" class="personalization-checkbox" data-price="${modificationPrice}" id="opt-${item.id}-back"><label for="opt-${item.id}-back">Derrière</label>
                      </div>
                      <div class="upload-section" id="upload-section-${item.id}-back" style="display:none;">
                        <label for="file-input-${item.id}-back" class="btn btn-small">Choisir fichier (derrière)</label>
                        <input type="file" id="file-input-${item.id}-back" accept="image/*" style="display:none;">
                        <div class="remove-bg-option">
                          <input type="checkbox" id="remove-bg-${item.id}-back" class="remove-bg-checkbox">
                          <label for="remove-bg-${item.id}-back">Enlever l'arrière-plan</label>
                        </div>
                        <div class="preview-wrapper"><img id="preview-${item.id}-back" src="#" alt="Aperçu" style="display:none;"></div>
                      </div>
                    </div>
                `;
            } else if (desc.includes('petit design poitrine')) {
                 optionsHtml = `
                    <div class="personalize-option-group">
                      <div class="personalize">
                        <input type="checkbox" class="personalization-checkbox" data-price="${modificationPrice}" id="opt-${item.id}-left"><label for="opt-${item.id}-left">Poitrine Gauche</label>
                      </div>
                      <div class="upload-section" id="upload-section-${item.id}-left" style="display:none;">
                        <label for="file-input-${item.id}-left" class="btn btn-small">Choisir fichier (gauche)</label>
                        <input type="file" id="file-input-${item.id}-left" accept="image/*" style="display:none;">
                        <div class="remove-bg-option">
                          <input type="checkbox" id="remove-bg-${item.id}-left" class="remove-bg-checkbox">
                          <label for="remove-bg-${item.id}-left">Enlever l'arrière-plan</label>
                        </div>
                        <div class="preview-wrapper"><img id="preview-${item.id}-left" src="#" alt="Aperçu" style="display:none;"></div>
                      </div>
                    </div>
                    <div class="personalize-option-group">
                      <div class="personalize">
                        <input type="checkbox" class="personalization-checkbox" data-price="${modificationPrice}" id="opt-${item.id}-right"><label for="opt-${item.id}-right">Poitrine Droite</label>
                      </div>
                      <div class="upload-section" id="upload-section-${item.id}-right" style="display:none;">
                        <label for="file-input-${item.id}-right" class="btn btn-small">Choisir fichier (droite)</label>
                        <input type="file" id="file-input-${item.id}-right" accept="image/*" style="display:none;">
                        <div class="remove-bg-option">
                          <input type="checkbox" id="remove-bg-${item.id}-right" class="remove-bg-checkbox">
                          <label for="remove-bg-${item.id}-right">Enlever l'arrière-plan</label>
                        </div>
                        <div class="preview-wrapper"><img id="preview-${item.id}-right" src="#" alt="Aperçu" style="display:none;"></div>
                      </div>
                    </div>
                `;
            } else if (item.personnalisation) { // Cas générique
                 optionsHtml = `
                    <div class="personalize-option-group">
                      <div class="personalize"><input type="checkbox" class="personalization-checkbox" data-price="${modificationPrice}" id="opt-${item.id}-generic"><label for="opt-${item.id}-generic">${item.personnalisation}</label></div>
                      <div class="upload-section" id="upload-section-${item.id}-generic" style="display:none;">
                        <label for="file-input-${item.id}-generic" class="btn btn-small">Choisir fichier</label>
                        <input type="file" id="file-input-${item.id}-generic" accept="image/*" style="display:none;">
                        <div class="remove-bg-option">
                          <input type="checkbox" id="remove-bg-${item.id}-generic" class="remove-bg-checkbox">
                          <label for="remove-bg-${item.id}-generic">Enlever l'arrière-plan</label>
                        </div>
                        <div class="preview-wrapper"><img id="preview-${item.id}-generic" src="#" alt="Aperçu" style="display:none;"></div>
                      </div>
                    </div>
                 `;
            }

            card.innerHTML = `
              <div class="card-image"><img src="${item.image_url || 'https://placehold.co/400x300/E7E7E7/A9A9A9?text=Image'}" alt="${item.nom}"></div>
              <div class="card-content">
                <h3>${item.nom}</h3>
                <p><strong>Prix modification:</strong> ${modificationPrice.toFixed(2)}$</p>
                ${optionsHtml}
              </div>`;
            customListEl.appendChild(card);
        });
    }

    // --- Helper pour définir les zones de placement ---
    function getPlacementBox(view, canvasWidth, canvasHeight) {
        const placements = {
            'front': { x: canvasWidth * 0.35, y: canvasHeight * 0.25, width: canvasWidth * 0.3, height: canvasHeight * 0.4 },
            'back': { x: canvasWidth * 0.35, y: canvasHeight * 0.2, width: canvasWidth * 0.3, height: canvasHeight * 0.5 },
            'left': { x: canvasWidth * 0.55, y: canvasHeight * 0.25, width: canvasWidth * 0.1, height: canvasHeight * 0.1 },
            'right': { x: canvasWidth * 0.35, y: canvasHeight * 0.25, width: canvasWidth * 0.1, height: canvasHeight * 0.1 },
            'sleeve_left': { x: canvasWidth * 0.4, y: canvasHeight * 0.4, width: canvasWidth * 0.2, height: canvasHeight * 0.2 },
            'sleeve_right': { x: canvasWidth * 0.4, y: canvasHeight * 0.4, width: canvasWidth * 0.2, height: canvasHeight * 0.2 }
        };
        // Si la vue est 'sleeve_left' ou 'sleeve_right', on utilise la clé correspondante.
        // Sinon, on utilise la vue simplifiée ('front', 'left', etc.)
        const key = state.currentView.startsWith('sleeve') ? state.currentView : view;
        return placements[key] || placements['front']; // Retourne 'front' par défaut
    }

    // --- Logique de la barre de commande (inspirée de V1) ---
    async function initializeOrderBar() {
        // IMPORTANT: Assurez-vous d'avoir une colonne 'table_name_ref' dans votre table 'products'
        // Pour le T-Shirt de base, la valeur doit être 'inventairetshirtdebase'
        const tableNameRef = state.product.table_name_ref;
        if (!tableNameRef) {
            console.error("La référence 'table_name_ref' est manquante pour ce produit dans la base de données.");
            return;
        }

        // Charger les couleurs
        const { data: colorsData } = await supa.from('product_available_colors').select('colors(id, name, hex_code)').eq('product_table_ref', tableNameRef);
        if (colorsData) {
            colorsData.forEach(item => {
                const color = item.colors;
                const option = document.createElement('option');
                option.value = color.hex_code;
                option.textContent = color.name;
                colorSelectEl.appendChild(option);
            });
        }

        // Initialiser la couleur par défaut
        state.currentColor = colorSelectEl.value;
        document.getElementById('color-preview').style.backgroundColor = state.currentColor;

        // Charger les tailles
        const { data: sizesData } = await supa.from('product_available_sizes').select('sizes(id, name)').eq('product_table_ref', tableNameRef).order('id', { referencedTable: 'sizes', ascending: true });
        if (sizesData) {
            sizesData.forEach(item => {
                const size = item.sizes;
                const sizeInputGroup = document.createElement('div');
                sizeInputGroup.className = 'size-input-group';
                sizeInputGroup.innerHTML = `
                    <label for="size-qty-${size.id}">${size.name}</label>
                    <input type="number" id="size-qty-${size.id}" class="size-quantity-input" min="0" value="0" data-size-id="${size.id}" data-size-name="${size.name}">
                `;
                sizeInputsContainerEl.appendChild(sizeInputGroup);
            });
            qtyInput.addEventListener('input', validateSizeQuantities);
            sizeInputsContainerEl.addEventListener('input', validateSizeQuantities);
        }

        // Charger les sexes
        const { data: gendersData } = await supa.from('product_available_genders').select('genders(id, name)').eq('product_table_ref', tableNameRef);
        if (gendersData) {
            gendersData.forEach(item => {
                const gender = item.genders;
                const option = document.createElement('option');
                option.value = gender.id;
                option.textContent = gender.name;
                genderSelectEl.appendChild(option);
            });
        }

        // Mettre à jour le total
        updateTotal();
    }

    function updateTotal() {
        if (!state.product) return;
        const qty = parseInt(qtyInput.value) || 1;
        const extraCost = Array.from(document.querySelectorAll('.personalization-checkbox:checked'))
          .reduce((sum, cb) => sum + parseFloat(cb.dataset.price), 0);
        
        const newTotalValue = (state.product.base_price + extraCost) * qty;
        totalEl.textContent = newTotalValue.toFixed(2);
    }

    // Fonction pour valider les quantités de tailles (copiée de V1)
    function validateSizeQuantities() {
        const masterQty = parseInt(qtyInput.value) || 0;
        const sizeInputs = document.querySelectorAll('.size-quantity-input');
        let totalSizeQty = 0;
        sizeInputs.forEach(input => { totalSizeQty += parseInt(input.value) || 0; });

        const sizeValidationMessage = document.getElementById('size-validation-message');
        if (totalSizeQty < masterQty) {
            sizeValidationMessage.textContent = `Il manque ${masterQty - totalSizeQty} article(s) à répartir.`;
            sizeValidationMessage.style.color = 'orange';
        } else if (totalSizeQty > masterQty) {
            sizeValidationMessage.textContent = `Vous avez réparti ${totalSizeQty - masterQty} article(s) en trop.`;
            sizeValidationMessage.style.color = 'red';
        } else {
            sizeValidationMessage.textContent = 'Le compte est bon !';
            sizeValidationMessage.style.color = 'green';
        }
    }

    // --- Chargement des données et initialisation ---
    async function initializePage() {
        const params = new URLSearchParams(window.location.search);
        const productId = params.get('id');

        if (!productId) {
            pageTitleEl.textContent = "Produit non trouvé";
            return;
        }

        const { data, error } = await supa.from('products').select('*').eq('id', productId).single();

        if (error || !data) {
            console.error("Erreur de chargement du produit:", error);
            pageTitleEl.textContent = "Erreur de chargement";
            return;
        }

        state.product = data;
        pageTitleEl.textContent = state.product.name;

        await generatePersonalizationCards();
        await initializeOrderBar();
        await renderProduct();
    }

    // --- Écouteurs d'événements ---
    colorSelectEl.addEventListener('change', (e) => {
        state.currentColor = e.target.value;
        document.getElementById('color-preview').style.backgroundColor = e.target.value;
        renderProduct();
    });

    viewSelectorEl.addEventListener('click', (e) => {
        if (e.target.classList.contains('view-btn')) {
            state.currentView = e.target.dataset.view;
            // Mettre à jour le bouton actif
            document.querySelector('.view-btn.active')?.classList.remove('active');
            e.target.classList.add('active');
            renderProduct();
        }
    });

    // Écouteurs pour la mise à jour du total
    qtyInput.addEventListener('input', updateTotal);
    customListEl.addEventListener('change', async (e) => {
        // Gérer les cases à cocher pour le prix et l'affichage de l'upload
        if (e.target.classList.contains('personalization-checkbox')) {
            updateTotal();
            const checkboxId = e.target.id;
            const baseId = checkboxId.replace('opt-', '');
            const uploadSection = document.getElementById(`upload-section-${baseId}`);
            if (uploadSection) {
                uploadSection.style.display = e.target.checked ? 'block' : 'none';
                if (!e.target.checked) {
                    // Réinitialiser si décoché
                    const fileInput = document.getElementById(`file-input-${baseId}`);
                    const preview = document.getElementById(`preview-${baseId}`);
                    if (fileInput) fileInput.value = '';
                    if (preview) {
                        preview.style.display = 'none';
                        preview.src = '#';
                    }
                    delete e.target.dataset.imageUrl;
                }
            }
            renderProduct(); // Mettre à jour l'aperçu quand on coche/décoche
        }

        // Gérer la sélection de fichier pour l'upload
        if (e.target.type === 'file' && e.target.id.startsWith('file-input-')) {
            const file = e.target.files[0];
            if (!file) return;

            const fileInput = e.target;
            const baseId = fileInput.id.replace('file-input-', '');
            const previewElement = document.getElementById(`preview-${baseId}`);
            const checkboxElement = document.getElementById(`opt-${baseId}`);
            const uploadLabel = fileInput.closest('.upload-section').querySelector('label');

            // Prévisualisation
            if (previewElement) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    previewElement.src = event.target.result;
                    previewElement.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }

            // Upload vers Supabase Storage
            if (uploadLabel) uploadLabel.textContent = 'Chargement...';
            fileInput.disabled = true;

            const sanitizedBaseName = file.name.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^\w.-]/g, '_').replace(/_{2,}/g, '_');
            const uniqueFileName = `${Date.now()}-${sanitizedBaseName}`;
            const { data: { user } } = await supa.auth.getUser();
            const filePath = user ? `${user.id}/${uniqueFileName}` : `public/${uniqueFileName}`;

            const { data: uploadData, error: uploadError } = await supa.storage.from('designs-clients').upload(filePath, file);

            if (uploadError) {
                console.error("Erreur d'upload Supabase:", uploadError);
                alert("Erreur lors de l'upload de l'image.");
                if (uploadLabel) uploadLabel.textContent = 'Choisir fichier';
                fileInput.disabled = false;
            } else {
                const { data: publicURLData } = supa.storage.from('designs-clients').getPublicUrl(uploadData.path);
                const originalImageUrl = publicURLData.publicUrl;
                let finalImageUrl = originalImageUrl;

                // Stocker l'URL originale immédiatement
                if (checkboxElement) {
                    checkboxElement.dataset.originalImageUrl = originalImageUrl;
                }

                // Vérifier si la suppression d'arrière-plan est demandée
                const removeBgCheckbox = document.getElementById(`remove-bg-${baseId}`);
                if (removeBgCheckbox && removeBgCheckbox.checked) {
                    if (uploadLabel) uploadLabel.innerHTML = `<div class="spinner"></div><span>Analyse IA (30s max)...</span>`;
                    try {
                        const { data: removeBgResponse, error: removeBgError } = await supa.functions.invoke('remove-background-replicate', {
                            body: { imageUrl: originalImageUrl },
                        });
                        if (removeBgError) throw removeBgError;
                        finalImageUrl = removeBgResponse.newImageUrl; // Mettre à jour avec la nouvelle URL
                    } catch (err) {
                        console.error("Erreur lors du retrait de l'arrière-plan:", err);
                        alert("Le retrait de l'arrière-plan a échoué. L'image originale sera utilisée.");
                    }
                }

                if (checkboxElement) {
                    checkboxElement.dataset.imageUrl = finalImageUrl;
                }
                renderProduct(); // Mettre à jour l'aperçu avec la nouvelle image
                if (uploadLabel) uploadLabel.textContent = 'Fichier chargé ✓';
                fileInput.disabled = false;
            }
        }

        // NOUVEAU: Gérer le changement de la case "Enlever l'arrière-plan"
        if (e.target.classList.contains('remove-bg-checkbox')) {
            console.log("Checkbox 'Enlever l'arrière-plan' cliquée.");
            const removeBgCheckbox = e.target;
            const uploadSection = removeBgCheckbox.closest('.upload-section');
            const uploadLabel = uploadSection.querySelector('label');
            
            // Reconstruire l'ID de la checkbox principale
            const baseId = removeBgCheckbox.id.replace('remove-bg-', '');
            const checkboxElement = document.getElementById(`opt-${baseId}`);
            console.log("Checkbox principale associée:", checkboxElement);

            // Ne rien faire si aucune image n'a été uploadée
            if (!checkboxElement || !checkboxElement.dataset.originalImageUrl) {
                console.log("Aucune image originale trouvée, l'action est ignorée.");
                return;
            }

            if (removeBgCheckbox.checked) {
                // L'utilisateur VEUT enlever l'arrière-plan
                if (uploadLabel) uploadLabel.innerHTML = `<div class="spinner"></div><span>Analyse IA (30s max)...</span>`;
                try {
                    const { data: removeBgResponse, error: removeBgError } = await supa.functions.invoke('remove-background-replicate', {
                        body: { imageUrl: checkboxElement.dataset.originalImageUrl },
                    });
                    console.log("Response from Edge Function:", { data: removeBgResponse, error: removeBgError });

                    if (removeBgError) throw removeBgError;
                    
                    // Mettre à jour l'URL de l'image à utiliser
                    checkboxElement.dataset.imageUrl = removeBgResponse.newImageUrl;
                    // Mettre à jour la prévisualisation dans la carte
                    renderProduct(); // Mettre à jour l'aperçu principal
                    const previewElement = document.getElementById(`preview-${baseId}`);
                    if (previewElement) previewElement.src = removeBgResponse.newImageUrl;

                    if (uploadLabel) uploadLabel.textContent = 'Fichier chargé ✓';

                } catch (err) {
                    console.error("Erreur lors du retrait de l'arrière-plan:", err);
                    alert("Le retrait de l'arrière-plan a échoué. L'image originale sera utilisée.");
                    if (uploadLabel) uploadLabel.textContent = 'Fichier chargé ✓';
                    removeBgCheckbox.checked = false; // Décocher la case en cas d'erreur
                }
            } else {
                // L'utilisateur NE VEUT PLUS enlever l'arrière-plan, on revient à l'original
                checkboxElement.dataset.imageUrl = checkboxElement.dataset.originalImageUrl;
                renderProduct(); // Mettre à jour l'aperçu principal
                // Mettre à jour la prévisualisation dans la carte
                const previewElement = document.getElementById(`preview-${baseId}`);
                if (previewElement) previewElement.src = checkboxElement.dataset.originalImageUrl;
            }
        }
    });

    initializePage();
  </script>
</body>
</html>