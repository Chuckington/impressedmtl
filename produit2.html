<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Configurateur de Produit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Supabase JS UMD via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Lien vers la feuille de style principale -->
  <link rel="stylesheet" href="assets/css/main.css">
  <!-- === FAVICON === -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <!-- =============== -->
</head>
<body>
  <header>
    <a href="inventaire.html" class="btn">← Retour à l’inventaire</a>
    <div class="header-title">
      <h1 id="page-title">Configurateur</h1>
    </div>
    <div style="display:flex; align-items:center; gap:8px;">
      <a href="panier.html" class="btn">Panier</a>
      <span id="user-email" style="color:#333;"></span>
      <button id="auth-button" class="btn">Se connecter</button>
    </div>
  </header>

  <div class="container configurator-container">
    <div class="configurator-options">
      <!-- Colonne de gauche pour les options -->
      <h2 id="product-title">Chargement...</h2>
      <p id="product-description"></p>

      <div class="option-section">
        <h3>Couleur</h3>
        <div id="color-selector-v2">
          <!-- Les pastilles de couleur seront générées ici -->
        </div>
      </div>

      <div class="option-section">
        <h3>Vue</h3>
        <div class="view-selector">
          <button class="btn view-btn active" data-view="front">Devant</button>
          <button class="btn view-btn" data-view="back">Dos</button>
          <!-- Ajoutez ici les boutons pour les manches si nécessaire -->
        </div>
      </div>

      <div class="option-section">
        <h3>Personnalisation</h3>
        <p>Ajoutez vos logos et designs sur les différentes zones.</p>
        <button class="btn">Personnaliser le devant</button>
        <button class="btn">Personnaliser le dos</button>
      </div>
    </div>

    <div class="configurator-preview">
      <!-- Colonne de droite pour l'aperçu canvas -->
      <canvas id="product-canvas" width="800" height="800"></canvas>
    </div>
  </div>

  <!-- La barre de commande sera simplifiée pour la V2 -->
  <div id="order-summary">
      <!-- À définir plus tard -->
  </div>

  <script>
    const supa = supabase.createClient(
      'https://vwvvbtcatamszncjuiso.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3dnZidGNhdGFtc3puY2p1aXNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NzM4ODksImV4cCI6MjA1ODI0OTg4OX0.Vnk3723jDNQdcl7HfVXZRtL6z0KxOLV4l872azuyEWA'
    );

    // --- DOM Elements ---
    const canvas = document.getElementById('product-canvas');
    const ctx = canvas.getContext('2d');
    const productTitleEl = document.getElementById('product-title');
    const productDescriptionEl = document.getElementById('product-description');
    const colorSelectorEl = document.getElementById('color-selector-v2');
    const viewSelectorEl = document.querySelector('.view-selector');

    // --- App State ---
    const state = {
        product: null,
        currentColor: '#000000', // Couleur par défaut
        currentView: 'front',    // Vue par défaut ('front', 'back', etc.)
        loadedImages: {}         // Cache pour les images déjà chargées
    };

    // --- Utilitaire de chargement d'image ---
    async function loadImage(url) {
        if (state.loadedImages[url]) {
            return state.loadedImages[url];
        }
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "Anonymous"; // Crucial pour le canvas
            img.onload = () => {
                state.loadedImages[url] = img;
                resolve(img);
            };
            img.onerror = reject;
            img.src = url;
        });
    }

    // --- Logique de rendu du Canvas ---
    async function renderProduct() {
        if (!state.product) return;

        const baseImageUrl = state.product[`asset_base_${state.currentView}`];
        const maskImageUrl = state.product[`asset_mask_${state.currentView}`];

        if (!baseImageUrl || !maskImageUrl) {
            console.error(`Assets pour la vue '${state.currentView}' non trouvés.`);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = "20px Fredoka, sans-serif";
            ctx.textAlign = "center";
            ctx.fillText("Aperçu non disponible", canvas.width / 2, canvas.height / 2);
            return;
        }

        try {
            const [baseImg, maskImg] = await Promise.all([loadImage(baseImageUrl), loadImage(maskImageUrl)]);

            canvas.width = baseImg.width;
            canvas.height = baseImg.height;

            // 1. Dessiner le masque (la forme noire)
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(maskImg, 0, 0);

            // 2. Remplir la forme avec la couleur choisie
            ctx.globalCompositeOperation = 'source-in';
            ctx.fillStyle = state.currentColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 3. Appliquer les ombres et la texture par-dessus
            ctx.globalCompositeOperation = 'multiply';
            ctx.drawImage(baseImg, 0, 0);

            // 4. Réinitialiser pour les futurs dessins (logos, etc.)
            ctx.globalCompositeOperation = 'source-over';

        } catch (error) {
            console.error("Erreur lors du rendu du canvas:", error);
        }
    }

    // --- Chargement des données et initialisation ---
    async function initializeConfigurator() {
        const params = new URLSearchParams(window.location.search);
        const productId = params.get('id');

        if (!productId) {
            productTitleEl.textContent = "Produit non trouvé";
            return;
        }

        const { data, error } = await supa.from('products').select('*').eq('id', productId).single();

        if (error || !data) {
            console.error("Erreur de chargement du produit:", error);
            productTitleEl.textContent = "Erreur de chargement";
            return;
        }

        state.product = data;
        productTitleEl.textContent = state.product.name;
        productDescriptionEl.textContent = state.product.description;

        // TODO: Remplacer par un appel à la base de données pour les couleurs disponibles
        const colors = [
            { name: 'Noir', hex: '#212529' }, { name: 'Blanc', hex: '#f8f9fa' },
            { name: 'Gris', hex: '#6c757d' }, { name: 'Rouge', hex: '#dc3545' },
            { name: 'Bleu Marine', hex: '#001f3f' }, { name: 'Vert Forêt', hex: '#228B22' }
        ];

        colorSelectorEl.innerHTML = '';
        colors.forEach((color, index) => {
            const swatch = document.createElement('div');
            swatch.className = 'color-swatch';
            swatch.style.backgroundColor = color.hex;
            swatch.dataset.color = color.hex;
            swatch.title = color.name;
            if (index === 0) {
                swatch.classList.add('active');
                state.currentColor = color.hex;
            }
            colorSelectorEl.appendChild(swatch);
        });

        await renderProduct();
    }

    // --- Écouteurs d'événements ---
    colorSelectorEl.addEventListener('click', (e) => {
        if (e.target.classList.contains('color-swatch')) {
            state.currentColor = e.target.dataset.color;
            document.querySelector('.color-swatch.active')?.classList.remove('active');
            e.target.classList.add('active');
            renderProduct();
        }
    });

    viewSelectorEl.addEventListener('click', (e) => {
        if (e.target.classList.contains('view-btn')) {
            state.currentView = e.target.dataset.view;
            document.querySelector('.view-btn.active')?.classList.remove('active');
            e.target.classList.add('active');
            renderProduct();
        }
    });

    initializeConfigurator();
  </script>
</body>
</html>