<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Configurateur de Produit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Supabase JS UMD via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Fabric.js pour le canvas interactif -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <!-- Lien vers la feuille de style principale -->
  <link rel="stylesheet" href="assets/css/main.css">
  <!-- === FAVICON === -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <!-- =============== -->
</head>
<body>
  <header>
    <a href="inventaire.html" class="btn">← Retour à l’inventaire</a>
    <div class="header-title">
      <h1 id="page-title">Chargement...</h1>
    </div>
    <div style="display:flex; align-items:center; gap:8px;">
      <a href="panier.html" class="btn">Panier</a>
      <span id="user-email" style="color:#333;"></span>
      <button id="auth-button" class="btn">Se connecter</button>
    </div>
  </header>

  <div class="container configurator-container">
    <div class="configurator-options">
      <!-- NOUVELLE SECTION POUR L'OFFRE SPÉCIALE -->
      <div id="offer-info-box" style="display:none; margin-bottom: 20px;"></div>
      <!-- Les cartes de personnalisation seront générées ici -->
      <div id="custom-list-v2" class="grid-v2"></div>
    </div>

    <div class="configurator-preview">
      <!-- Colonne de droite pour l'aperçu canvas -->
      <canvas id="product-canvas"></canvas>
      <div class="view-selector">
        <button class="btn view-btn active" data-view="front">Devant</button>
        <button class="btn view-btn" data-view="back">Dos</button>
        <button class="btn view-btn" data-view="sleeve_left">Manche Gauche</button>
        <button class="btn view-btn" data-view="sleeve_right">Manche Droite</button>
      </div>
      <button id="download-preview-btn" class="btn" style="margin-top: 20px;">Télécharger l'aperçu</button>
    </div>
  </div>

  <!-- NOUVELLE SECTION POUR LA DESCRIPTION EN BAS -->
  <div class="container description-full-width-container">
    <div id="product-description-box" class="card" style="display: none;">
      <div class="card-content">
        <h3>À propos de ce produit</h3>
        <p id="product-description-text"></p>
      </div>
    </div>
  </div>

  <!-- Barre de commande identique à produit.html -->
  <div id="order-summary">
    <div class="order-summary-top-row">
        <div class="option-group">
            <label for="quantity">Quantité:</label>
            <input type="number" id="quantity" value="1" min="1">
        </div>
        <div class="option-group" id="color-option-group">
            <label for="color-select">Couleur:</label>
            <div class="color-input-wrapper">
                <select id="color-select"><option value="">Choisir...</option></select>
                <span id="color-preview"></span>
            </div>
        </div>
        <div class="option-group" id="gender-option-group">
            <label for="gender-select">Sexe:</label>
            <select id="gender-select"><option value="">Choisir...</option></select>
        </div>
        <div class="summary-actions-container">
            <div class="total-price-display">Total: <span id="total-price">0.00</span> $</div>
            <button id="add-to-cart" class="btn">Ajouter au panier</button>
        </div>
    </div>
    <div class="order-summary-bottom-row">
      <div class="option-group" id="size-option-group">
        <label>Tailles :</label>
        <div class="size-inputs-column">
          <div id="size-inputs-container" class="size-inputs-wrapper"></div>
          <div id="size-validation-message"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const supa = supabase.createClient(
      'https://vwvvbtcatamszncjuiso.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ3dnZidGNhdGFtc3puY2p1aXNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NzM4ODksImV4cCI6MjA1ODI0OTg4OX0.Vnk3723jDNQdcl7HfVXZRtL6z0KxOLV4l872azuyEWA'
    );

    // --- Auth Logic (identique à V1) ---
    // ... (le code d'authentification peut être copié/collé ici si nécessaire)

    // --- DOM Elements ---
    // Remplacer le contexte 2D natif par une instance de Fabric.js
    const fabricCanvas = new fabric.Canvas('product-canvas', {
        width: 800, // Taille initiale, sera ajustée
        height: 800,
        backgroundColor: '#f0f0f0' // Fond temporaire
    });
    const pageTitleEl = document.getElementById('page-title');
    const customListEl = document.getElementById('custom-list-v2');
    const viewSelectorEl = document.querySelector('.view-selector');
    const colorSelectEl = document.getElementById('color-select');
    const qtyInput = document.getElementById('quantity');
    const genderSelectEl = document.getElementById('gender-select');
    const sizeInputsContainerEl = document.getElementById('size-inputs-container');
    const totalEl = document.getElementById('total-price');

    // --- App State ---
    const state = {
        product: null,
        currentColor: '#FFFFFF', // Couleur par défaut (blanc)
        currentView: 'front',    // Vue par défaut ('front', 'back', etc.)
        loadedImages: {},        // Cache pour les images déjà chargées
    logos: {},               // Pour stocker les objets Fabric.js des logos
    logoTransforms: {},      // NOUVEAU: Pour stocker les transformations des logos
    isInitialRender: true,   // Pour savoir si c'est le premier rendu
    placementZones: {},      // Pour stocker les zones de placement depuis la DB
    colorHasBeenSelected: false // NOUVEAU: Pour savoir si l'utilisateur a choisi une couleur
    };

    // --- Utilitaire de chargement d'image ---
    async function loadImage(url) {
        if (!url) return null;
        if (state.loadedImages[url]) return state.loadedImages[url];
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "Anonymous"; // Crucial pour le canvas
            img.onload = () => {
                state.loadedImages[url] = img;
                resolve(img);
            };
            img.onerror = () => reject(new Error(`Impossible de charger l'image: ${url}`));
            img.src = url;
        });
    }

    // --- Logique de rendu du Canvas ---
    async function renderProductBase() {
        if (!state.product) return;

        // Sélectionne les URLs des images en fonction de la vue actuelle
        const baseImageUrl = state.product[`asset_base_${state.currentView}`];
        const maskImageUrl = state.product[`asset_mask_${state.currentView}`];

        if (!baseImageUrl) {
            console.error(`Assets pour la vue '${state.currentView}' non trouvés.`);
            fabricCanvas.setBackgroundImage(null); // Nettoyer l'ancien fond
            fabricCanvas.renderAll();
            return;
        }

        try {
            const baseImg = await loadImage(baseImageUrl);

            // --- NOUVELLE LOGIQUE DE REDIMENSIONNEMENT ---
            // Obtenir la largeur du conteneur parent pour rendre le canvas responsive
            const previewContainer = document.querySelector('.configurator-preview');
            const containerWidth = previewContainer.clientWidth - 40; // -40 pour le padding (20px de chaque côté)

            // Calculer le facteur d'échelle et les nouvelles dimensions du canvas
            const scaleFactor = containerWidth / baseImg.width;
            const canvasWidth = baseImg.width * scaleFactor;
            const canvasHeight = baseImg.height * scaleFactor;

            // Si le produit n'a pas de masque, ou si aucune couleur n'a été choisie, on affiche juste l'image de base.
            if (!maskImageUrl || !state.colorHasBeenSelected) {
                fabricCanvas.setDimensions({ width: canvasWidth, height: canvasHeight });
                fabricCanvas.setBackgroundImage(baseImg.src, fabricCanvas.renderAll.bind(fabricCanvas), {
                    scaleX: scaleFactor,
                    scaleY: scaleFactor,
                });
                await updateLogosOnCanvas();
                drawPlacementZones();
                return; // On s'arrête ici pour ces produits
            }

            // Pour les produits avec masque, on continue la logique de colorisation
            const maskImg = await loadImage(maskImageUrl);
            // Utiliser un canvas temporaire pour créer l'image de fond
            const offscreenCanvas = document.createElement('canvas');
            const offscreenCtx = offscreenCanvas.getContext('2d');
            offscreenCanvas.width = baseImg.width;
            offscreenCanvas.height = baseImg.height;

            offscreenCtx.drawImage(maskImg, 0, 0);
            offscreenCtx.globalCompositeOperation = 'source-in';
            offscreenCtx.fillStyle = state.currentColor;
            offscreenCtx.fillRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);
            offscreenCtx.globalCompositeOperation = 'multiply';
            offscreenCtx.drawImage(baseImg, 0, 0);

            // Mettre à jour le canvas Fabric.js avec les nouvelles dimensions et l'image de fond redimensionnée
            fabricCanvas.setDimensions({ width: canvasWidth, height: canvasHeight });
            fabricCanvas.setBackgroundImage(offscreenCanvas.toDataURL(), fabricCanvas.renderAll.bind(fabricCanvas), {
                scaleX: scaleFactor,
                scaleY: scaleFactor,
            });

            // Mettre à jour les logos
            await updateLogosOnCanvas();
            drawPlacementZones(); // Affiche les zones pour les options déjà cochées

        } catch (error) {
            console.error("Erreur lors du rendu du canvas:", error);
        }
    }

    async function updateLogosOnCanvas() {
        // Supprimer les anciens logos
        fabricCanvas.getObjects('image').forEach(obj => fabricCanvas.remove(obj));

        const checkedPersonalizations = document.querySelectorAll('.personalization-checkbox:checked');

        for (const checkbox of checkedPersonalizations) {
            const placementKey = checkbox.dataset.placementKey;
            const viewForLogo = checkbox.dataset.view; // La vue générique ('front', 'back', etc.)

            // Si la personnalisation cochée a une image
            if (checkbox.dataset.imageUrl && placementKey && viewForLogo) {
                try {
                    const logoImgElement = await loadImage(checkbox.dataset.imageUrl);
                    
                    const savedTransform = state.logoTransforms[checkbox.id];
                    const placement = getPlacementBox(placementKey, fabricCanvas.width, fabricCanvas.height);

                    const fabricImage = new fabric.Image(logoImgElement, {
                        left: savedTransform ? savedTransform.left : placement.x,
                        top: savedTransform ? savedTransform.top : placement.y,
                        scaleX: savedTransform ? savedTransform.scaleX : 1,
                        scaleY: savedTransform ? savedTransform.scaleY : 1,
                        angle: savedTransform ? savedTransform.angle : 0,
                        // Rendre visible seulement si la vue du logo correspond à la vue actuelle
                        visible: isLogoVisibleInView(viewForLogo, state.currentView),
                        custom_view: viewForLogo, // Stocker la vue pour référence future
                        custom_id: checkbox.id, // Stocker l'ID de la checkbox pour référence
                        custom_placementBox: placement, // Stocker la boîte de placement
                        // Style des contrôles
                        cornerColor: '#007bff',
                        cornerSize: 12,
                        transparentCorners: false,
                        borderColor: '#007bff',
                        borderDashArray: [5, 5]
                    });

                    // Si aucune transformation n'est sauvegardée, on applique l'échelle par défaut.
                    if (!savedTransform) {
                        fabricImage.scaleToWidth(placement.width);
                    }

                    // Stocker l'échelle initiale pour la comparaison de qualité
                    fabricImage.set('initialScale', fabricImage.scaleX);

                    fabricCanvas.add(fabricImage);
                } catch (error) {
                    console.error(`Impossible de dessiner le logo pour la vue ${viewForLogo}:`, error);
                }
            }
        }
        fabricCanvas.renderAll();
    }

    // --- Génération des cartes de personnalisation (similaire à V1) ---
    async function generatePersonalizationCards() {
        // Récupérer les options de personnalisation depuis la table spécifique (ex: inventairetshirtdebase)
        const tableNameRef = state.product.table_name_ref;
        if (!tableNameRef) {
            console.error("La référence 'table_name_ref' est manquante pour ce produit.");
            customListEl.innerHTML = '<p>Options de personnalisation non disponibles.</p>';
            return;
        }

        const { data: options, error } = await supa
            .from(tableNameRef)
            .select('*')
            .order('nom', { ascending: true });

        if (error) {
            console.error("Erreur lors du chargement des options de personnalisation:", error);
            customListEl.innerHTML = '<p>Erreur de chargement des options.</p>';
            return;
        }

        // NOUVELLE LOGIQUE: Si aucune option de personnalisation n'est trouvée dans la table,
        // on considère que c'est un produit simple avec une seule zone de design.
        if (!options || options.length === 0) {
            customListEl.innerHTML = `
                <div class="card">
                  <div class="card-content">
                    <h3>Votre Design</h3>
                    <p>Téléversez votre image pour la placer sur le produit.</p>
                    <div class="personalize-option-group">
                      <div class="personalize" style="display: none;">
                        <input type="checkbox" class="personalization-checkbox" data-price="0" id="opt-simple-front" data-view="front" data-placement-key="default_front" checked><label for="opt-simple-front">Design</label>
                      </div>
                      <div class="upload-section" id="upload-section-simple-front" style="display:block;">
                        <label for="file-input-simple-front" class="btn btn-small">Choisir fichier</label>
                        <input type="file" id="file-input-simple-front" accept="image/*" style="display:none;">
                        <div class="remove-bg-option">
                          <input type="checkbox" id="remove-bg-simple-front" class="remove-bg-checkbox">
                          <label for="remove-bg-simple-front">Enlever l'arrière-plan</label>
                          <div class="info-tooltip-wrapper">
                            <span class="info-icon">ⓘ</span>
                            <div class="info-tooltip">Si le résultat n'est pas satisfaisant, <a href="mailto:impressed.mtl@gmail.com?subject=Design pour ma commande - Impressed MTL">contactez-nous</a> avec votre design.</div>
                          </div>
                        </div>
                        <div class="quality-warning" id="quality-warning-simple-front" style="display:none;">⚠️ Qualité d'impression potentiellement réduite.</div>
                        <div class="preview-wrapper"><img id="preview-simple-front" src="#" alt="Aperçu" style="display:none;"></div>
                      </div>
                    </div>
                  </div>
                </div>`;
            return; // On s'arrête ici pour ces produits
        }

        customListEl.innerHTML = '';
        options.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            let optionsHtml = '';
            const modificationPrice = parseFloat(item.prix) || 0;

            const desc = (item.personnalisation || '').toLowerCase();

            if (desc.includes('gros design')) {
                // Pour les produits simples, on force l'utilisation de 'default_front'
                // même si la personnalisation s'appelle "Gros design".
                const simpleFrontProducts = ['inventairetablier', 'inventairetuque']; // Tote bag retiré pour utiliser gros_design_front
                const frontPlacementKey = simpleFrontProducts.includes(tableNameRef) ? 'default_front' : 'gros_design_front';
                const backPlacementKey = 'gros_design_back';

                // Option pour le devant (sauf pour la veste)
                if (tableNameRef !== 'inventaireveste') {
                    optionsHtml += `
                    <div class="personalize-option-group">
                      <div class="personalize">
                        <input type="checkbox" class="personalization-checkbox" data-price="${modificationPrice}" id="opt-${item.id}-front" data-view="front" data-placement-key="${frontPlacementKey}"><label for="opt-${item.id}-front">Devant</label>
                      </div>
                      <div class="upload-section" id="upload-section-${item.id}-front" style="display:none;">
                        <label for="file-input-${item.id}-front" class="btn btn-small">Choisir fichier (devant)</label>
                        <input type="file" id="file-input-${item.id}-front" accept="image/*" style="display:none;">
                        <div class="remove-bg-option">
                          <input type="checkbox" id="remove-bg-${item.id}-front" class="remove-bg-checkbox">
                          <label for="remove-bg-${item.id}-front">Enlever l'arrière-plan</label>
                          <div class="info-tooltip-wrapper">
                            <span class="info-icon">ⓘ</span>
                            <div class="info-tooltip">Si le résultat n'est pas satisfaisant, <a href="mailto:impressed.mtl@gmail.com?subject=Design pour ma commande - Impressed MTL">contactez-nous</a> avec votre design.</div>
                          </div>
                        </div>
                        <div class="quality-warning" id="quality-warning-${item.id}-front" style="display:none;">⚠️ Qualité d'impression potentiellement réduite.</div>
                        <div class="preview-wrapper"><img id="preview-${item.id}-front" src="#" alt="Aperçu" style="display:none;"></div>
                      </div>
                    </div>
                    `;
                }
                // Option pour le derrière (conditionnelle, pas pour le tablier)
                if (tableNameRef !== 'inventairetablier') {
                    optionsHtml += `
                        <div class="personalize-option-group">
                          <div class="personalize">
                            <input type="checkbox" class="personalization-checkbox" data-price="${modificationPrice}" id="opt-${item.id}-back" data-view="back" data-placement-key="${backPlacementKey}"><label for="opt-${item.id}-back">Derrière</label>
                          </div>
                          <div class="upload-section" id="upload-section-${item.id}-back" style="display:none;">
                            <label for="file-input-${item.id}-back" class="btn btn-small">Choisir fichier (derrière)</label>
                            <input type="file" id="file-input-${item.id}-back" accept="image/*" style="display:none;">
                            <div class="remove-bg-option">
                              <input type="checkbox" id="remove-bg-${item.id}-back" class="remove-bg-checkbox">
                              <label for="remove-bg-${item.id}-back">Enlever l'arrière-plan</label>
                              <div class="info-tooltip-wrapper">
                                <span class="info-icon">ⓘ</span>
                                <div class="info-tooltip">Si le résultat n'est pas satisfaisant, <a href="mailto:impressed.mtl@gmail.com?subject=Design pour ma commande - Impressed MTL">contactez-nous</a> avec votre design.</div>
                              </div>
                            </div>
                            <div class="quality-warning" id="quality-warning-${item.id}-back" style="display:none;">⚠️ Qualité d'impression potentiellement réduite.</div>
                            <div class="preview-wrapper"><img id="preview-${item.id}-back" src="#" alt="Aperçu" style="display:none;"></div>
                          </div>
                        </div>
                    `;
                }
            } else if (desc.includes('petit design poitrine')) {
                 const specificKey = 'petit_design_poitrine';
                 optionsHtml += `
                    <div class="personalize-option-group">
                      <div class="personalize">
                        <input type="checkbox" class="personalization-checkbox" data-price="${modificationPrice}" id="opt-${item.id}-left" data-view="front" data-placement-key="${specificKey}_left"><label for="opt-${item.id}-left">Poitrine Gauche</label>
                      </div>
                      <div class="upload-section" id="upload-section-${item.id}-left" style="display:none;">
                        <label for="file-input-${item.id}-left" class="btn btn-small">Choisir fichier (gauche)</label>
                        <input type="file" id="file-input-${item.id}-left" accept="image/*" style="display:none;">
                        <div class="remove-bg-option">
                          <input type="checkbox" id="remove-bg-${item.id}-left" class="remove-bg-checkbox">
                          <label for="remove-bg-${item.id}-left">Enlever l'arrière-plan</label>
                          <div class="info-tooltip-wrapper">
                            <span class="info-icon">ⓘ</span>
                            <div class="info-tooltip">Si le résultat n'est pas satisfaisant, <a href="mailto:impressed.mtl@gmail.com?subject=Design pour ma commande - Impressed MTL">contactez-nous</a> avec votre design.</div>
                          </div>
                        </div>
                        <div class="quality-warning" id="quality-warning-${item.id}-left" style="display:none;">⚠️ Qualité d'impression potentiellement réduite.</div>
                        <div class="preview-wrapper"><img id="preview-${item.id}-left" src="#" alt="Aperçu" style="display:none;"></div>
                      </div>
                    </div>
                    <div class="personalize-option-group">
                      <div class="personalize">
                        <input type="checkbox" class="personalization-checkbox" data-price="${modificationPrice}" id="opt-${item.id}-right" data-view="front" data-placement-key="${specificKey}_right"><label for="opt-${item.id}-right">Poitrine Droite</label>
                      </div>
                      <div class="upload-section" id="upload-section-${item.id}-right" style="display:none;">
                        <label for="file-input-${item.id}-right" class="btn btn-small">Choisir fichier (droite)</label>
                        <input type="file" id="file-input-${item.id}-right" accept="image/*" style="display:none;">
                        <div class="remove-bg-option">
                          <input type="checkbox" id="remove-bg-${item.id}-right" class="remove-bg-checkbox">
                          <label for="remove-bg-${item.id}-right">Enlever l'arrière-plan</label>
                          <div class="info-tooltip-wrapper">
                            <span class="info-icon">ⓘ</span>
                            <div class="info-tooltip">Si le résultat n'est pas satisfaisant, <a href="mailto:impressed.mtl@gmail.com?subject=Design pour ma commande - Impressed MTL">contactez-nous</a> avec votre design.</div>
                          </div>
                        </div>
                        <div class="quality-warning" id="quality-warning-${item.id}-right" style="display:none;">⚠️ Qualité d'impression potentiellement réduite.</div>
                        <div class="preview-wrapper"><img id="preview-${item.id}-right" src="#" alt="Aperçu" style="display:none;"></div>
                      </div>
                    </div>
                 `;
            } else if (desc.includes('manche gauche')) {
                optionsHtml += `
                    <div class="personalize-option-group">
                      <div class="personalize"><input type="checkbox" class="personalization-checkbox" data-price="${modificationPrice}" id="opt-${item.id}-sleeve-left" data-view="sleeve_left" data-placement-key="manche_gauche"><label for="opt-${item.id}-sleeve-left">${item.personnalisation}</label></div>
                      <div class="upload-section" id="upload-section-${item.id}-sleeve-left" style="display:none;">
                        <label for="file-input-${item.id}-sleeve-left" class="btn btn-small">Choisir fichier</label>
                        <input type="file" id="file-input-${item.id}-sleeve-left" accept="image/*" style="display:none;">
                        <div class="remove-bg-option">
                          <input type="checkbox" id="remove-bg-${item.id}-sleeve-left" class="remove-bg-checkbox">
                          <label for="remove-bg-${item.id}-sleeve-left">Enlever l'arrière-plan</label>
                          <div class="info-tooltip-wrapper">
                            <span class="info-icon">ⓘ</span>
                            <div class="info-tooltip">Si le résultat n'est pas satisfaisant, <a href="mailto:impressed.mtl@gmail.com?subject=Design pour ma commande - Impressed MTL">contactez-nous</a> avec votre design.</div>
                          </div>
                        </div>
                        <div class="quality-warning" id="quality-warning-${item.id}-sleeve-left" style="display:none;">⚠️ Qualité d'impression potentiellement réduite.</div>
                        <div class="preview-wrapper"><img id="preview-${item.id}-sleeve-left" src="#" alt="Aperçu" style="display:none;"></div>
                      </div>
                    </div>
                `;
            } else if (desc.includes('manche droite')) {
                optionsHtml += `
                    <div class="personalize-option-group">
                      <div class="personalize"><input type="checkbox" class="personalization-checkbox" data-price="${modificationPrice}" id="opt-${item.id}-sleeve-right" data-view="sleeve_right" data-placement-key="manche_droite"><label for="opt-${item.id}-sleeve-right">${item.personnalisation}</label></div>
                      <div class="upload-section" id="upload-section-${item.id}-sleeve-right" style="display:none;">
                        <label for="file-input-${item.id}-sleeve-right" class="btn btn-small">Choisir fichier</label>
                        <input type="file" id="file-input-${item.id}-sleeve-right" accept="image/*" style="display:none;">
                        <div class="remove-bg-option">
                          <input type="checkbox" id="remove-bg-${item.id}-sleeve-right" class="remove-bg-checkbox">
                          <label for="remove-bg-${item.id}-sleeve-right">Enlever l'arrière-plan</label>
                          <div class="info-tooltip-wrapper">
                            <span class="info-icon">ⓘ</span>
                            <div class="info-tooltip">Si le résultat n'est pas satisfaisant, <a href="mailto:impressed.mtl@gmail.com?subject=Design pour ma commande - Impressed MTL">contactez-nous</a> avec votre design.</div>
                          </div>
                        </div>
                        <div class="quality-warning" id="quality-warning-${item.id}-sleeve-right" style="display:none;">⚠️ Qualité d'impression potentiellement réduite.</div>
                        <div class="preview-wrapper"><img id="preview-${item.id}-sleeve-right" src="#" alt="Aperçu" style="display:none;"></div>
                      </div>
                    </div>
                `;
            } else if (item.personnalisation) { // Cas générique pour Tuque, Tote bag, etc.
                optionsHtml += `
                    <div class="personalize-option-group">
                      <div class="personalize"><input type="checkbox" class="personalization-checkbox" data-price="${modificationPrice}" id="opt-${item.id}-default" data-view="front" data-placement-key="default_front"><label for="opt-${item.id}-default">${item.personnalisation}</label></div>
                      <div class="upload-section" id="upload-section-${item.id}-default" style="display:none;">
                        <label for="file-input-${item.id}-default" class="btn btn-small">Choisir fichier</label>
                        <input type="file" id="file-input-${item.id}-default" accept="image/*" style="display:none;">
                        <div class="remove-bg-option">
                          <input type="checkbox" id="remove-bg-${item.id}-default" class="remove-bg-checkbox">
                          <label for="remove-bg-${item.id}-default">Enlever l'arrière-plan</label>
                          <div class="info-tooltip-wrapper">
                            <span class="info-icon">ⓘ</span>
                            <div class="info-tooltip">Si le résultat n'est pas satisfaisant, <a href="mailto:impressed.mtl@gmail.com?subject=Design pour ma commande - Impressed MTL">contactez-nous</a> avec votre design.</div>
                          </div>
                        </div>
                        <div class="quality-warning" id="quality-warning-${item.id}-default" style="display:none;">⚠️ Qualité d'impression potentiellement réduite.</div>
                        <div class="preview-wrapper"><img id="preview-${item.id}-default" src="#" alt="Aperçu" style="display:none;"></div>
                      </div>
                    </div>
                 `;
            }

            card.innerHTML = `
              <div class="card-image"><img src="${item.image_url || 'https://placehold.co/400x300/E7E7E7/A9A9A9?text=Image'}" alt="${item.nom}"></div>
              <div class="card-content">
                <h3>${item.nom}</h3>
                <p><strong>Prix modification:</strong> ${modificationPrice.toFixed(2)}$</p>
                ${optionsHtml}
              </div>`;
            customListEl.appendChild(card);
        });
    }

    // --- Helper pour définir les zones de placement ---
    function getPlacementBox(placementKey, canvasWidth, canvasHeight) {
        // --- Taille de référence de vos images sources ---
        const NATIVE_IMAGE_WIDTH = 6250;
        const NATIVE_IMAGE_HEIGHT = 6250;

        // --- Récupérer la configuration depuis l'état de l'application ---
        const placementConfig = state.placementZones[placementKey];

        // --- Gérer le cas où aucune zone n'est définie dans la DB ---
        if (!placementConfig) {
            console.warn(`Aucune zone de placement définie dans la base de données pour la clé '${placementKey}'. Utilisation d'une zone par défaut.`);
            // Coordonnées par défaut en PIXELS (basées sur 2000x2000)
            const defaultPlacement = { x: 700, y: 500, width: 600, height: 800 }; // Un défaut générique
            
            const scaleX = canvasWidth / NATIVE_IMAGE_WIDTH;
            const scaleY = canvasHeight / NATIVE_IMAGE_HEIGHT;

            return {
                x: defaultPlacement.x * scaleX,
                y: defaultPlacement.y * scaleY,
                width: defaultPlacement.width * scaleX,
                height: defaultPlacement.height * scaleY
            };
        }

        // --- Calculer les coordonnées finales à partir des données de la DB ---
        const scaleX = canvasWidth / NATIVE_IMAGE_WIDTH;
        const scaleY = canvasHeight / NATIVE_IMAGE_HEIGHT;

        return {
            x: placementConfig.x * scaleX,
            y: placementConfig.y * scaleY,
            width: placementConfig.width * scaleX,
            height: placementConfig.height * scaleY
        };
    }

    // --- NOUVEAU: Dessine les zones de placement pour les options cochées ---
    function drawPlacementZones() {
        // 1. Nettoyer les anciennes zones
        fabricCanvas.getObjects().forEach(obj => {
            if (obj.custom_type === 'placement_box') {
                fabricCanvas.remove(obj);
            }
        });

        // 2. Obtenir toutes les options de personnalisation cochées
        const checkedPersonalizations = document.querySelectorAll('.personalization-checkbox:checked');

        checkedPersonalizations.forEach(checkbox => {
            const placementKey = checkbox.dataset.placementKey;
            const viewForZone = checkbox.dataset.view;

            if (!placementKey || !viewForZone) return;

            // 3. Vérifier si cette zone doit être visible dans la vue actuelle
            if (isLogoVisibleInView(viewForZone, state.currentView)) {
                const box = getPlacementBox(placementKey, fabricCanvas.width, fabricCanvas.height);
                
                const rect = new fabric.Rect({
                    left: box.x, top: box.y, width: box.width, height: box.height,
                    fill: 'rgba(0,0,0,0)',
                    stroke: 'rgba(255, 255, 255, 0.7)', // Trait blanc semi-transparent
                    strokeWidth: 1,
                    strokeDashArray: [5, 5],
                    shadow: { color: 'rgba(0,0,0,0.8)', blur: 3 }, // Ombre noire pour le contraste
                    selectable: false, evented: false, custom_type: 'placement_box'
                });
                fabricCanvas.add(rect);
                fabricCanvas.sendToBack(rect);
            }
        });
        fabricCanvas.renderAll();
    }

    function isLogoVisibleInView(logoView, currentCanvasView) {
        if (logoView === currentCanvasView) {
            return true;
        }
        // Cas spécial : afficher les logos de poitrine (gauche/droite) sur la vue de face
        if (currentCanvasView === 'front' && (logoView === 'left' || logoView === 'right')) {
            return true;
        }
        return false;
    }

    // --- Logique de la barre de commande (inspirée de V1) ---
    async function initializeOrderBar() {
        // IMPORTANT: Assurez-vous d'avoir une colonne 'table_name_ref' dans votre table 'products'
        // Pour le T-Shirt de base, la valeur doit être 'inventairetshirtdebase'
        const tableNameRef = state.product.table_name_ref;
        if (!tableNameRef) {
            console.error("La référence 'table_name_ref' est manquante pour ce produit dans la base de données.");
            return;
        }

        // Charger les couleurs
        const { data: colorsData } = await supa.from('product_available_colors').select('colors(id, name, hex_code)').eq('product_table_ref', tableNameRef);
        if (colorsData) {
            colorsData.forEach(item => {
                const color = item.colors;
                const option = document.createElement('option');
                option.value = color.hex_code;
                option.textContent = color.name;
                colorSelectEl.appendChild(option);
            });
        }

        // Initialiser la couleur par défaut
        state.currentColor = colorSelectEl.value;
        document.getElementById('color-preview').style.backgroundColor = state.currentColor;

        // Charger les tailles
        const { data: sizesData } = await supa.from('product_available_sizes').select('sizes(id, name)').eq('product_table_ref', tableNameRef).order('id', { referencedTable: 'sizes', ascending: true });
        if (sizesData) {
            sizesData.forEach(item => {
                const size = item.sizes;
                const sizeInputGroup = document.createElement('div');
                sizeInputGroup.className = 'size-input-group';
                sizeInputGroup.innerHTML = `
                    <label for="size-qty-${size.id}">${size.name}</label>
                    <input type="number" id="size-qty-${size.id}" class="size-quantity-input" min="0" value="0" data-size-id="${size.id}" data-size-name="${size.name}">
                `;
                sizeInputsContainerEl.appendChild(sizeInputGroup);
            });
            qtyInput.addEventListener('input', validateSizeQuantities);
            sizeInputsContainerEl.addEventListener('input', validateSizeQuantities);
        }

        // Charger les sexes
        const { data: gendersData } = await supa.from('product_available_genders').select('genders(id, name)').eq('product_table_ref', tableNameRef);
        if (gendersData) {
            gendersData.forEach(item => {
                const gender = item.genders;
                const option = document.createElement('option');
                option.value = gender.id;
                option.textContent = gender.name;
                genderSelectEl.appendChild(option);
            });
        }

        // Mettre à jour le total
        updateTotal();
    }

    function updateTotal() {
        if (!state.product) return;
        const qty = parseInt(qtyInput.value) || 1;
        const extraCost = Array.from(document.querySelectorAll('.personalization-checkbox:checked'))
          .reduce((sum, cb) => sum + parseFloat(cb.dataset.price), 0);
        
        const newTotalValue = (state.product.base_price + extraCost) * qty;
        totalEl.textContent = newTotalValue.toFixed(2);
    }

    // Fonction pour valider les quantités de tailles (copiée de V1)
    function validateSizeQuantities() {
        const masterQty = parseInt(qtyInput.value) || 0;
        const sizeInputs = document.querySelectorAll('.size-quantity-input');
        let totalSizeQty = 0;
        sizeInputs.forEach(input => { totalSizeQty += parseInt(input.value) || 0; });

        const sizeValidationMessage = document.getElementById('size-validation-message');
        if (totalSizeQty < masterQty) {
            sizeValidationMessage.textContent = `Il manque ${masterQty - totalSizeQty} article(s) à répartir.`;
            sizeValidationMessage.style.color = 'orange';
        } else if (totalSizeQty > masterQty) {
            sizeValidationMessage.textContent = `Vous avez réparti ${totalSizeQty - masterQty} article(s) en trop.`;
            sizeValidationMessage.style.color = 'red';
        } else {
            sizeValidationMessage.textContent = 'Le compte est bon !';
            sizeValidationMessage.style.color = 'green';
        }
    }

    // --- Chargement des données et initialisation ---
    async function initializePage() {
        const params = new URLSearchParams(window.location.search);
        const productId = params.get('id');

        if (!productId) {
            pageTitleEl.textContent = "Produit non trouvé";
            return;
        }

        const { data, error } = await supa.from('products').select('*').eq('id', productId).single();

        if (error || !data) {
            console.error("Erreur de chargement du produit:", error);
            pageTitleEl.textContent = "Erreur de chargement";
            return;
        }

        state.product = data;
        pageTitleEl.textContent = state.product.name;

        // NOUVEAU: Afficher l'offre spéciale si applicable
        const offerInfoBox = document.getElementById('offer-info-box');
        const tableNameRef = state.product.table_name_ref;
        if (offerInfoBox && tableNameRef === 'inventairetshirtdebase') {
            offerInfoBox.style.display = 'block';
            offerInfoBox.innerHTML = `
              <h3>✨ Offre Spéciale ✨</h3>
              <p>Commandez <strong>20 unités</strong> avec un "Gros design derrière" ET un "Petit design poitrine" (gauche ou droite) pour un prix fixe de <strong>300$</strong> ! Le rabais sera appliqué automatiquement dans le panier.</p>
            `;
        } else if (offerInfoBox && tableNameRef === 'inventairetshirtpremium') {
            offerInfoBox.style.display = 'block';
            offerInfoBox.innerHTML = `
              <h3>✨ Offre Spéciale ✨</h3>
              <p>Commandez <strong>20 unités</strong> avec un "Gros design derrière" ET un "Petit design poitrine" (gauche ou droite) pour un prix fixe de <strong>420$</strong> ! Le rabais sera appliqué automatiquement dans le panier.</p>
            `;
        }

        // NOUVEAU: Afficher la description du produit
        const descriptionBox = document.getElementById('product-description-box');
        const descriptionText = document.getElementById('product-description-text');
        // On vérifie que les éléments existent et que la description n'est pas vide
        if (descriptionBox && descriptionText && state.product.description && state.product.description.trim() !== '') {
            descriptionText.textContent = state.product.description;
            descriptionBox.style.display = 'block';
        }

        // --- NOUVEAU: Charger les zones de placement depuis la base de données ---
        const { data: zonesData, error: zonesError } = await supa
            .from('product_placement_zones')
            .select('view_name, x, y, width, height')
            .eq('product_id', productId);

        if (zonesError) {
            console.error("Erreur lors du chargement des zones de placement:", zonesError);
        } else if (zonesData) {
            // Convertir le tableau de zones en un objet pour un accès facile (ex: state.placementZones['front'])
            state.placementZones = zonesData.reduce((acc, zone) => {
                acc[zone.view_name] = { x: zone.x, y: zone.y, width: zone.width, height: zone.height };
                return acc;
            }, {});
            console.log("Zones de placement chargées:", state.placementZones);
        }

        // --- NOUVEAU: Cacher les boutons de vue non disponibles ---
        viewSelectorEl.querySelector('[data-view="front"]').style.display = state.product.asset_base_front ? 'inline-block' : 'none';
        viewSelectorEl.querySelector('[data-view="back"]').style.display = state.product.asset_base_back ? 'inline-block' : 'none';
        viewSelectorEl.querySelector('[data-view="sleeve_left"]').style.display = state.product.asset_base_sleeve_left ? 'inline-block' : 'none';
        viewSelectorEl.querySelector('[data-view="sleeve_right"]').style.display = state.product.asset_base_sleeve_right ? 'inline-block' : 'none';

        await generatePersonalizationCards();
        await initializeOrderBar();
        await renderProductBase();
        state.isInitialRender = false; // On met le flag à false après le premier rendu
    }

    // --- Écouteurs d'événements ---
    colorSelectEl.addEventListener('change', (e) => {
        state.currentColor = e.target.value;
        state.colorHasBeenSelected = true; // Indiquer qu'une couleur a été choisie
        document.getElementById('color-preview').style.backgroundColor = e.target.value;
        renderProductBase();
    });

    viewSelectorEl.addEventListener('click', (e) => {
        if (e.target.classList.contains('view-btn')) {
            state.currentView = e.target.dataset.view;
            // Mettre à jour le bouton actif
            document.querySelector('.view-btn.active')?.classList.remove('active');
            e.target.classList.add('active');
            // Changer le fond et la visibilité des logos
            renderProductBase();
            fabricCanvas.getObjects('image').forEach(obj => {
                obj.set('visible', isLogoVisibleInView(obj.custom_view, state.currentView));
            });
            drawPlacementZones(); // Redessiner les zones pour la nouvelle vue
            fabricCanvas.renderAll();
        }
    });

    // --- NOUVEAU: Logique d'interaction avec le canvas ---

    // NOUVEAU: Sauvegarder les transformations quand l'utilisateur modifie un logo
    fabricCanvas.on('object:modified', (e) => {
        const obj = e.target;
        if (obj && obj.custom_id) {
            state.logoTransforms[obj.custom_id] = {
                left: obj.left,
                top: obj.top,
                scaleX: obj.scaleX,
                scaleY: obj.scaleY,
                angle: obj.angle
            };
        }
    });

    // Contraint le logo à l'intérieur de sa zone de placement
    fabricCanvas.on('object:moving', (e) => {
        const obj = e.target;
        const box = obj.custom_placementBox;
        if (!box) return;

        // Obtenir les dimensions de l'objet après mise à l'échelle
        const objWidth = obj.getScaledWidth();
        const objHeight = obj.getScaledHeight();

        // Contraindre la limite gauche
        if (obj.left < box.x) {
            obj.left = box.x;
        }
        // Contraindre la limite droite
        if (obj.left + objWidth > box.x + box.width) {
            obj.left = box.x + box.width - objWidth;
        }
        // Contraindre la limite haute
        if (obj.top < box.y) {
            obj.top = box.y;
        }
        // Contraindre la limite basse
        if (obj.top + objHeight > box.y + box.height) {
            obj.top = box.y + box.height - objHeight;
        }
    });

    // NOUVEAU: Contraint le redimensionnement du logo pour qu'il ne dépasse pas la boîte
    fabricCanvas.on('object:scaling', (e) => {
        const obj = e.target;
        const box = obj.custom_placementBox;
        if (!box) return;

        const objWidth = obj.getScaledWidth();
        const objHeight = obj.getScaledHeight();

        // Empêcher le logo de devenir plus grand que la boîte
        if (objWidth > box.width) {
            obj.scaleX = box.width / obj.width;
        }
        if (objHeight > box.height) {
            obj.scaleY = box.height / obj.height;
        }

        // --- NOUVELLE LOGIQUE D'AVERTISSEMENT DE QUALITÉ ---
        const warningThreshold = 2.0; // Avertir si l'échelle est 2x plus grande que l'initiale
        const isTooLarge = obj.scaleX > (obj.initialScale * warningThreshold);

        // Trouver l'élément d'avertissement correspondant dans la carte de gauche
        const checkboxId = obj.custom_id;
        if (checkboxId) {
            const baseId = checkboxId.replace('opt-', '');
            const warningEl = document.getElementById(`quality-warning-${baseId}`);
            if (warningEl) {
                warningEl.style.display = isTooLarge ? 'block' : 'none';
            }
        }
    });

    // Écouteurs pour la mise à jour du total
    qtyInput.addEventListener('input', updateTotal);
    customListEl.addEventListener('change', async (e) => {
        // Gérer les cases à cocher pour le prix et l'affichage de l'upload
        if (e.target.classList.contains('personalization-checkbox')) {
            updateTotal();
            const checkboxId = e.target.id;
            const baseId = checkboxId.replace('opt-', '');
            const uploadSection = document.getElementById(`upload-section-${baseId}`);
            if (uploadSection) {
                uploadSection.style.display = e.target.checked ? 'block' : 'none';
                if (!e.target.checked) {
                    // Réinitialiser si décoché
                    const fileInput = document.getElementById(`file-input-${baseId}`);
                    const preview = document.getElementById(`preview-${baseId}`);
                    if (fileInput) fileInput.value = '';
                    if (preview) {
                        preview.style.display = 'none';
                        preview.src = '#';
                    }
                    delete e.target.dataset.imageUrl;
                }
            }

            // --- NOUVELLE LOGIQUE : Changer la vue de l'aperçu ---
            if (e.target.checked) { // On change la vue seulement quand on coche la case
                const viewForCheckbox = e.target.dataset.view;
                
                // Simuler un clic sur le bouton de vue correspondant
                const viewButton = viewSelectorEl.querySelector(`.view-btn[data-view="${viewForCheckbox}"]`);
                if (viewButton && state.currentView !== viewForCheckbox) {
                    viewButton.click();
                }
            }
            await updateLogosOnCanvas();
            drawPlacementZones();
        }

        // Gérer la sélection de fichier pour l'upload
        if (e.target.type === 'file' && e.target.id.startsWith('file-input-')) {
            const file = e.target.files[0];
            if (!file) return;

            const fileInput = e.target;
            const baseId = fileInput.id.replace('file-input-', '');
            const previewElement = document.getElementById(`preview-${baseId}`);
            const checkboxElement = document.getElementById(`opt-${baseId}`);
            const uploadLabel = fileInput.closest('.upload-section').querySelector('label');

            // Prévisualisation
            if (previewElement) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    previewElement.src = event.target.result;
                    previewElement.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }

            // Upload vers Supabase Storage
            if (uploadLabel) uploadLabel.textContent = 'Chargement...';
            fileInput.disabled = true;

            const sanitizedBaseName = file.name.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^\w.-]/g, '_').replace(/_{2,}/g, '_');
            const uniqueFileName = `${Date.now()}-${sanitizedBaseName}`;
            const { data: { user } } = await supa.auth.getUser();
            const filePath = user ? `${user.id}/${uniqueFileName}` : `public/${uniqueFileName}`;

            const { data: uploadData, error: uploadError } = await supa.storage.from('designs-clients').upload(filePath, file);

            if (uploadError) {
                console.error("Erreur d'upload Supabase:", uploadError);
                alert("Erreur lors de l'upload de l'image.");
                if (uploadLabel) uploadLabel.textContent = 'Choisir fichier';
                fileInput.disabled = false;
            } else {
                const { data: publicURLData } = supa.storage.from('designs-clients').getPublicUrl(uploadData.path);
                const originalImageUrl = publicURLData.publicUrl;
                let finalImageUrl = originalImageUrl;

                // Stocker l'URL originale immédiatement
                if (checkboxElement) {
                    checkboxElement.dataset.originalImageUrl = originalImageUrl;
                }

                // Vérifier si la suppression d'arrière-plan est demandée
                const removeBgCheckbox = document.getElementById(`remove-bg-${baseId}`);
                if (removeBgCheckbox && removeBgCheckbox.checked) {
                    if (uploadLabel) uploadLabel.innerHTML = `<div class="spinner"></div><span>Analyse IA (30s max)...</span>`;
                    try {
                        const { data: removeBgResponse, error: removeBgError } = await supa.functions.invoke('remove-background-replicate', {
                            body: { imageUrl: originalImageUrl },
                        });
                        if (removeBgError) throw removeBgError;
                        finalImageUrl = removeBgResponse.newImageUrl; // Mettre à jour avec la nouvelle URL
                    } catch (err) {
                        console.error("Erreur lors du retrait de l'arrière-plan:", err);
                        alert("Le retrait de l'arrière-plan a échoué. L'image originale sera utilisée.");
                    }
                }

                if (checkboxElement) {
                    checkboxElement.dataset.imageUrl = finalImageUrl;
                }
                await updateLogosOnCanvas(); // Mettre à jour l'aperçu avec la nouvelle image
                if (uploadLabel) uploadLabel.textContent = 'Fichier chargé ✓';
                fileInput.disabled = false;
            }
        }

        // NOUVEAU: Gérer le changement de la case "Enlever l'arrière-plan"
        if (e.target.classList.contains('remove-bg-checkbox')) {
            console.log("Checkbox 'Enlever l'arrière-plan' cliquée.");
            const removeBgCheckbox = e.target;
            const uploadSection = removeBgCheckbox.closest('.upload-section');
            const uploadLabel = uploadSection.querySelector('label');
            
            // Reconstruire l'ID de la checkbox principale
            const baseId = removeBgCheckbox.id.replace('remove-bg-', '');
            const checkboxElement = document.getElementById(`opt-${baseId}`);
            console.log("Checkbox principale associée:", checkboxElement);

            // Ne rien faire si aucune image n'a été uploadée
            if (!checkboxElement || !checkboxElement.dataset.originalImageUrl) {
                console.log("Aucune image originale trouvée, l'action est ignorée.");
                return;
            }

            if (removeBgCheckbox.checked) {
                // L'utilisateur VEUT enlever l'arrière-plan
                if (uploadLabel) uploadLabel.innerHTML = `<div class="spinner"></div><span>Analyse IA (30s max)...</span>`;
                try {
                    const { data: removeBgResponse, error: removeBgError } = await supa.functions.invoke('remove-background-replicate', {
                        body: { imageUrl: checkboxElement.dataset.originalImageUrl },
                    });
                    console.log("Response from Edge Function:", { data: removeBgResponse, error: removeBgError });

                    if (removeBgError) throw removeBgError;
                    
                    // Mettre à jour l'URL de l'image à utiliser
                    checkboxElement.dataset.imageUrl = removeBgResponse.newImageUrl;
                    await updateLogosOnCanvas(); // Mettre à jour l'aperçu principal
                    // Mettre à jour la prévisualisation dans la carte
                    const previewElement = document.getElementById(`preview-${baseId}`);
                    if (previewElement) previewElement.src = removeBgResponse.newImageUrl;

                    if (uploadLabel) uploadLabel.textContent = 'Fichier chargé ✓';

                } catch (err) {
                    console.error("Erreur lors du retrait de l'arrière-plan:", err);
                    alert("Le retrait de l'arrière-plan a échoué. L'image originale sera utilisée.");
                    if (uploadLabel) uploadLabel.textContent = 'Fichier chargé ✓';
                    removeBgCheckbox.checked = false; // Décocher la case en cas d'erreur
                }
            } else {
                // L'utilisateur NE VEUT PLUS enlever l'arrière-plan, on revient à l'original
                checkboxElement.dataset.imageUrl = checkboxElement.dataset.originalImageUrl;
                await updateLogosOnCanvas(); // Mettre à jour l'aperçu principal
                // Mettre à jour la prévisualisation dans la carte
                const previewElement = document.getElementById(`preview-${baseId}`);
                if (previewElement) previewElement.src = checkboxElement.dataset.originalImageUrl;
            }
        }
    });

    // --- Helper pour dessiner un rectangle avec des coins arrondis ---
    function drawRoundedRect(ctx, x, y, width, height, radius) {
        ctx.beginPath();
        ctx.moveTo(x + radius, y);
        ctx.lineTo(x + width - radius, y);
        ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
        ctx.lineTo(x + width, y + height - radius);
        ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
        ctx.lineTo(x + radius, y + height);
        ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
        ctx.lineTo(x, y + radius);
        ctx.quadraticCurveTo(x, y, x + radius, y);
        ctx.closePath();
    }

    // --- NOUVEAU: Logique de téléchargement de l'aperçu ---
    async function downloadCanvasAsImage() {
        const downloadBtn = document.getElementById('download-preview-btn');
        downloadBtn.disabled = true;
        downloadBtn.textContent = 'Préparation...';

        // Cacher les zones de placement avant l'export
        fabricCanvas.getObjects().forEach(obj => {
            if (obj.custom_type === 'placement_box') {
                obj.set('visible', false);
            }
        });
        fabricCanvas.renderAll();

        try {
            // Créer un canvas temporaire pour le rendu haute résolution et le watermark
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');

            // Utiliser un multiplicateur pour une meilleure résolution
            const multiplier = 2;
            tempCanvas.width = fabricCanvas.getWidth() * multiplier;
            tempCanvas.height = fabricCanvas.getHeight() * multiplier;

            // Dessiner l'état actuel du canvas Fabric sur le canvas temporaire en haute résolution
            const canvasDataURL = fabricCanvas.toDataURL({ format: 'png', quality: 1.0, multiplier: multiplier });
            const canvasImage = await loadImage(canvasDataURL);
            tempCtx.drawImage(canvasImage, 0, 0);

            // --- NOUVELLE LOGIQUE POUR LE WATERMARK ---
            const watermarkText = 'impressedmtl.com';
            const padding = 30; // Plus de padding pour la haute résolution
            const fontSize = 32; // Police plus grande
            const boxPadding = { x: 20, y: 10 };
            const boxRadius = 8;
            
            tempCtx.font = `bold ${fontSize}px Fredoka, sans-serif`;
            const textMetrics = tempCtx.measureText(watermarkText);
            
            const boxWidth = textMetrics.width + (boxPadding.x * 2);
            const boxHeight = fontSize + (boxPadding.y * 2);
            const boxX = tempCanvas.width - boxWidth - padding;
            const boxY = tempCanvas.height - boxHeight - padding;

            // Dessiner le rectangle blanc arrondi
            tempCtx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            drawRoundedRect(tempCtx, boxX, boxY, boxWidth, boxHeight, boxRadius);
            tempCtx.fill();

            // Dessiner le texte noir par-dessus
            tempCtx.fillStyle = '#1a1a1a';
            tempCtx.textAlign = 'center';
            tempCtx.textBaseline = 'middle';
            tempCtx.fillText(watermarkText, boxX + boxWidth / 2, boxY + boxHeight / 2 + 2); // +2 pour un meilleur centrage vertical

            // Créer le lien de téléchargement
            const link = document.createElement('a');
            link.download = 'apercu-impressedmtl.png';
            link.href = tempCanvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        } catch (error) {
            console.error("Erreur lors du téléchargement de l'aperçu:", error);
            alert("Une erreur est survenue lors de la création de l'aperçu.");
        } finally {
            // Réafficher les zones de placement
            fabricCanvas.getObjects().forEach(obj => {
                if (obj.custom_type === 'placement_box') {
                    obj.set('visible', true);
                }
            });
            fabricCanvas.renderAll();

            downloadBtn.disabled = false;
            downloadBtn.textContent = "Télécharger l'aperçu";
        }
    }

    initializePage();

    document.getElementById('download-preview-btn').addEventListener('click', downloadCanvasAsImage);
  </script>
  <script>
    // --- NOUVEAU: Logique "Ajouter au Panier" pour la V2 ---
    document.getElementById('add-to-cart').addEventListener('click', async () => {
        try {
            const addToCartBtn = document.getElementById('add-to-cart');
            addToCartBtn.disabled = true;
            addToCartBtn.innerHTML = `<div class="spinner"></div>`;

            // NOUVEAU: Générer et uploader l'image d'aperçu final
            let finalPreviewPublicUrl = null;
            // Cacher les zones de placement avant de générer l'image
            fabricCanvas.getObjects().forEach(obj => {
                if (obj.custom_type === 'placement_box') obj.set('visible', false);
            });
            fabricCanvas.renderAll();
            
            const dataUrl = fabricCanvas.toDataURL({ format: 'png', quality: 0.8 });
            const blob = await (await fetch(dataUrl)).blob();
            const fileName = `final-preview-${Date.now()}.png`;
            const { data: { user: authUser } } = await supa.auth.getUser();
            const filePath = authUser ? `${authUser.id}/previews/${fileName}` : `public/previews/${fileName}`;

            const { data: uploadData, error: uploadError } = await supa.storage.from('designs-clients').upload(filePath, blob);

            if (uploadError) {
                console.error("Erreur lors de l'upload de l'aperçu final:", uploadError);
            } else {
                const { data: publicURLData } = supa.storage.from('designs-clients').getPublicUrl(uploadData.path);
                finalPreviewPublicUrl = publicURLData.publicUrl;
            }

            const qty = parseInt(qtyInput.value) || 1;
            if (!state.product) {
                alert("Erreur: les données du produit n'ont pas pu être chargées.");
                return;
            }

            // --- Construction des données de personnalisation avec les transformations ---
            let personalizationsData = [];
            const checkedPersonalizations = document.querySelectorAll('.personalization-checkbox:checked');

            for (const cbCheckbox of checkedPersonalizations) {
                const labelElement = cbCheckbox.labels[0];
                const label = labelElement ? labelElement.textContent.trim() : `Option ${cbCheckbox.id}`;
                const view = cbCheckbox.dataset.view; // NOUVEAU: Récupérer la vue
                const price = parseFloat(cbCheckbox.dataset.price) || 0;

                // Trouver le logo correspondant sur le canvas
                const idParts = cbCheckbox.id.split('-');
                const fabricLogo = fabricCanvas.getObjects('image').find(obj => obj.custom_id === cbCheckbox.id);

                let transformData = null;
                if (fabricLogo) {
                    transformData = {
                        left: fabricLogo.left,
                        top: fabricLogo.top,
                        scaleX: fabricLogo.scaleX,
                        scaleY: fabricLogo.scaleY,
                        angle: fabricLogo.angle,
                        // Sauvegarder les dimensions du canvas pour un repositionnement proportionnel
                        canvasWidth: fabricCanvas.width,
                        canvasHeight: fabricCanvas.height
                    };
                }

                personalizationsData.push({
                    spot_label: label,
                    spot_price: price,
                    image_url: cbCheckbox.dataset.imageUrl || null,
                    transform: transformData, // Le "plan de montage" du logo
                    view: view // NOUVEAU: Ajouter la vue
                });
            }

            // --- Récupération des autres options (couleur, sexe, etc.) ---
            const selectedColorOption = colorSelectEl.selectedOptions[0];
            const selectedColor = selectedColorOption && selectedColorOption.value ?
                                  { name: selectedColorOption.textContent, hex: selectedColorOption.value } : null;

            const selectedGenderOption = genderSelectEl.selectedOptions[0];
            const selectedGender = selectedGenderOption && selectedGenderOption.value ?
                                   { id: selectedGenderOption.value, name: selectedGenderOption.textContent } : null;

            // --- Logique pour les tailles multiples (identique à V1) ---
            const sizeInputs = document.querySelectorAll('.size-quantity-input');
            const cartItemsToAdd = [];
            let totalSizeQty = 0;

            sizeInputs.forEach(input => {
                const sizeQty = parseInt(input.value) || 0;
                totalSizeQty += sizeQty;
                if (sizeQty > 0) {
                    cartItemsToAdd.push({
                        product_id: `v2_${state.product.id}`, // Préfixe pour identifier les produits V2
                        product_name: state.product.name,
                        quantity: sizeQty,
                        personalizations: personalizationsData,
                        base_price: state.product.base_price,
                        selected_color_name: selectedColor ? selectedColor.name : null,
                        selected_size_name: input.dataset.sizeName,
                        selected_gender_name: selectedGender ? selectedGender.name : null,
                        product_assets: { // NOUVEAU: Ajouter les assets du produit
                            front: state.product.asset_base_front,
                            back: state.product.asset_base_back,
                            sleeve_left: state.product.asset_base_sleeve_left,
                            sleeve_right: state.product.asset_base_sleeve_right
                        },
                        final_preview_url: finalPreviewPublicUrl // NOUVEAU: Ajouter l'URL de l'aperçu
                    });
                }
            });

            // --- Validation (identique à V1) ---
            if (qty > 0 && totalSizeQty !== qty) {
                alert('La somme des quantités par taille ne correspond pas à la quantité totale demandée.');
                return;
            }
            if (qty > 0 && cartItemsToAdd.length === 0) {
                alert('Veuillez spécifier les quantités pour au moins une taille.');
                return;
            }
            if (qty === 0) {
                alert('Veuillez choisir une quantité supérieure à 0.');
                return;
            }

            // --- Sauvegarde dans le panier (identique à V1) ---
            const { data: { user } } = await supa.auth.getUser();
            if (user) {
                const { error: insertError } = await supa.from('cart_items').insert(cartItemsToAdd);
                if (insertError) {
                    console.error("Erreur lors de l'ajout au panier (Supabase):", insertError);
                    alert(`Erreur lors de l'ajout au panier: ${insertError.message}.`);
                    return;
                }
            } else {
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                cart.push(...cartItemsToAdd);
                localStorage.setItem('cart', JSON.stringify(cart));
            }

            alert('Article(s) ajouté(s) au panier !');
            window.location.href = 'panier.html';

        } catch (error) {
            console.error("Erreur inattendue dans la fonction d'ajout au panier:", error);
            alert("Une erreur inattendue est survenue. Veuillez vérifier la console pour plus de détails.");
        } finally {
            // Réafficher les zones de placement et réactiver le bouton
            fabricCanvas.getObjects().forEach(obj => {
                if (obj.custom_type === 'placement_box') obj.set('visible', true);
            });
            fabricCanvas.renderAll();
            const addToCartBtn = document.getElementById('add-to-cart');
            addToCartBtn.disabled = false;
            addToCartBtn.textContent = 'Ajouter au panier';
        }
    });
  </script>
</body>
</html>